<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>belingud</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_859455_eaq7v6w8ktj.css">
</head>
<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link" >
                首页
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                归档
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                标签
            </a>
            

            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">Victor's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">首页</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">归档</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">标签</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">关于</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/07/17/服务器配置/">服务器配置</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-07-17</span>
                
            </div>
            <div class="post-content">
                
                    <p>[TOC]</p>
<h1 id="服务器配置">服务器配置</h1>
<h2 id="1-redis">1. redis</h2>
<h3 id="安装">安装</h3>
<p>redis官网：<a href="https://redis.io/" target="_blank" rel="noopener">https://redis.io/</a></p>
<p>点击上方的<strong>Download</strong>，在下方的下载按钮点击右键，复制下载链接。在命令行输入<code>wget 下载链接 保存目录</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-5.0.5.tar.gz</span><br></pre></td></tr></table></figure>
<p>下载一个后缀为.tar.gz的压缩包。进入到下载的目录中，命令行运行<code>tar xz redis-5.0.5.tar.gz</code>，完成解压，自动创建一个同名目录</p>
<p>进入目录下：<code>cd redis-5.0.5.tar.gz</code>，运行<code>make</code>，完成后运行<code>make test</code>进行测试。</p>
<p>进入安装文件的目录：<code>cd redis-5.0.5.tar.gz/utils</code>，运行安装脚本<code>./install_server.sh</code>，运行失败则使用bash命令运行<code>bash install_server.sh</code>，等待安装完成。</p>
<h3 id="配置">配置</h3>
<p>安装完成后需要对redis进行配置，使其支持远程链接，或者将其加入到服务器族群中，配置文件在<code>/etc/redis/6379.conf</code>中，在命令模式下输入<code>/bind</code>，找到<code>bind 127.0.0.1</code>，将其注释掉。使服务器的redis服务支持远程链接。</p>
<p>如果你的redis需要密码，在命令模式下输入<code>/requirepass foobared</code>，回车，按<kbd>N</kbd>键依次查找，找到</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> requirepass foobared</span></span><br></pre></td></tr></table></figure>
<p>的一行，删除注释，将后面的foobared替换为你需要修改的密码，保存退出。</p>
<p>重启redis服务<code>service redis-server restart</code></p>
<h2 id="2-nginx">2. nginx</h2>
<h3 id="1-安装">1. 安装</h3>
<p>nginx官网：<a href="http://nginx.org/" target="_blank" rel="noopener">http://nginx.org/</a></p>
<p>点击右侧<strong>documentation</strong>，是nginx的官方文档，找到第一项<strong>installing nginx</strong>，会列出安装方式，在Ubuntu中，可以找到<strong>Installation on Linux</strong>，点击<strong>packages</strong>，在列表里面找到Ubuntu，点击进入，Debin既是Ubuntu的类别，需要在命令行输入一下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curl gnupg2 ca-certificates lsb-release</span><br><span class="line">echo "deb http://nginx.org/packages/debian `lsb_release -cs` nginx" \</span><br><span class="line">    | sudo tee /etc/apt/sources.list.d/nginx.list</span><br><span class="line">curl -fsSL https://nginx.org/keys/nginx_signing.key | sudo apt-key add -</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查证书</span></span><br><span class="line">sudo apt-key fingerprint ABF5BD827BD9BF62</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure>
<h3 id="2-配置文件">2. 配置文件</h3>
<h4 id="创建">创建</h4>
<h5 id="包含的配置项">包含的配置项</h5>
<p>在需要的位置创建配置文件，文件名为<code>xxx.conf</code>，配置文件是一个json内容的文件，在nginx安装完成之后，在目录<code>/etc/nginx/conf.d/default.conf</code>里面有默认的配置项<strong>server</strong>，在目录<code>/etc/nginx/nginx.conf</code>里面有默认的其他配置项：</p>
<ul>
<li>user：worker进程运行的用户和组</li>
<li>worker_process：子进程数，建议为核心数</li>
<li>pid：进程id保存位置</li>
<li>events：工作模式，连接配置
<ul>
<li>use：工作模式
<ul>
<li>epoll：高效工作模式Linux</li>
<li>kqueue：高效工作模式bsd</li>
<li>poll：标准模式</li>
<li>select：标准模式</li>
</ul>
</li>
<li>worker_connections：单进程最大连接数
<ul>
<li>正向代理：连接数×进程数</li>
<li>反向代理：连接数×进程数/4</li>
</ul>
</li>
</ul>
</li>
<li>http：http配置
<ul>
<li>include mime.types：设置文件mime类型</li>
<li>default_type：设置默认类型为二进制流，未见类型未知时使用默认</li>
<li>access_log：链接日志</li>
<li>sendfile：是否传输文件</li>
<li>keepalive_timeout：活跃超时</li>
<li>gzip：网络传输的压缩格式</li>
</ul>
</li>
</ul>
<p><strong>server</strong>主机的配置项：</p>
<ul>
<li>listen：端口号</li>
<li>server_name localhost：制定ip或域名，多个域名用空格隔开</li>
<li>location：url匹配
<ul>
<li>/</li>
<li>/static</li>
</ul>
</li>
<li>location
<ul>
<li>/50x.html</li>
</ul>
</li>
<li>root：制定虚拟主机的根目录</li>
<li>index：制定默认首页</li>
</ul>
<h5 id="创建配置">创建配置</h5>
<p>将<code>/etc/nginx/nginx.conf</code>和<code>/etc/nginx/nginx.d/default.conf</code>，的内容复制到需要创建的文件中，建议使用项目名<code>ProjectName.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    #gzip  on;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        # 配置访问根路由时的行为，链接到8000端口的django程序</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://localhost:8000;</span><br><span class="line">        &#125;</span><br><span class="line">        # 配置静态文件目录</span><br><span class="line">        location /static &#123;</span><br><span class="line">            alias /var/www/public/static;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   /usr/share/nginx/html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好访问根路由时的行为，链接到8000端口的Django程序，配置localtion是nginx的关键，包含了Django中接口的信息。</p>
<p>location的语法：<code>location [modifier] url{...}</code></p>
<p>modifer修饰符，分为以下几个：</p>
<ul>
<li>=	使用精确匹配并终止查询</li>
<li>~    区分大写的正则表达式</li>
<li>~*    不区分大小写的正则表达式</li>
<li>^~    最佳匹配，不是正则匹配，通常用来匹配目录</li>
</ul>
<p>alias：别名，定义location的其他名字，如果location指定了正则表达式，alias将会引用正则表达式中的捕获，alias代替location中匹配的部分</p>
<h3 id="3-启动nginx">3. 启动nginx</h3>
<p>配置信息写好后，需要重启nginx服务，让其加载写好的配置文件</p>
<p>nginx的常用命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx -s signal(信号)</span><br><span class="line">		stop 快速关闭</span><br><span class="line">		quit 优雅的关闭</span><br><span class="line">		reload 重新加载配置</span><br><span class="line">nginx -v 版本信息</span><br></pre></td></tr></table></figure>
<p>nginx配置文件的使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx -t	#不运行，仅测试配置文件</span><br><span class="line">nginx -c configpath		#从指定路径加载配置文件启动</span><br><span class="line">nginx -t -c configpath	#测试指定配置文件</span><br></pre></td></tr></table></figure>
<p>location的语法：<code>location [modifier] url{...}</code></p>
<p>modifer修饰符，分为以下几个：</p>
<ul>
<li>=	使用精确匹配并终止查询</li>
<li>~    区分大写的正则表达式</li>
<li>~*    不区分大小写的正则表达式</li>
<li>^~    最佳匹配，不是正则匹配，通常用来匹配目录</li>
</ul>
<p>alias：别名，定义location的其他名字，如果location指定了正则表达式，alias将会引用正则表达式中的捕获，alias代替location中匹配的部分</p>
<h3 id="3-启动nginx-v2">3. 启动nginx</h3>
<p>配置信息写好后，需要重启nginx服务，让其加载写好的配置文件</p>
<p>nginx的常用命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx -s signal(信号)</span><br><span class="line">		stop 快速关闭</span><br><span class="line">		quit 优雅的关闭</span><br><span class="line">		reload 重新加载配置</span><br><span class="line">nginx -v 版本信息</span><br></pre></td></tr></table></figure>
<p>nginx配置文件的使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx -t	#不运行，仅测试配置文件</span><br><span class="line">nginx -c configpath		#从指定路径加载配置文件启动</span><br><span class="line">nginx -t -c configpath	#测试指定配置文件</span><br></pre></td></tr></table></figure>
<hr>
<br>
<br>
<br>
<p>uwsgi的配置可以参考无天法师的博客：<a href="https://www.imooc.com/article/21751" target="_blank" rel="noopener">https://www.imooc.com/article/21751</a></p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/07/17/Django总结/">Django概述</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-07-17</span>
                
            </div>
            <div class="post-content">
                
                    <h1 id="django概述">Django概述</h1>
<p>Django和Flask属于同一种框架，不过Django属于重量级框架封装了大量的方法，书写时代码更加简洁。Django1.11会支持到2020，首先需要安装Django</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django==1.11.7</span><br></pre></td></tr></table></figure>
<h2 id="创建">创建</h2>
<ol>
<li>使用命令行</li>
</ol>
<p>创建工程：<code>django-admin startproject ProjectName</code></p>
<p>创建应用：<code>python manage.py startapp AppName</code></p>
<p>新创建的app需要在主框架settings.py中的<code>INSTALLED_APPS</code>中注册，在列表中追加<code>‘AppName’</code>即可。</p>
<ol start="2">
<li>使用pycharm</li>
</ol>
<p>项目类型选择Django</p>
<h2 id="启动">启动</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver</span><br></pre></td></tr></table></figure>
<p>默认启动在本机的8000端口，如果要实现远程访问，需要在settings.py中设置<code>ALLOW_HOSTS = [&quot;*&quot;]</code>，然后在启动时添加参数。</p>
<p>可以添加IP和端口，或者单独添加端口，不能只添加IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver 0.0.0.0:8000</span><br><span class="line">python manage.py runserver 9000</span><br></pre></td></tr></table></figure>
<h2 id="组成">组成</h2>
<p>目录结构树如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">├── App</span><br><span class="line">│   ├── admin.py</span><br><span class="line">│   ├── apps.py</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── migrations</span><br><span class="line">│   │   └── __init__.py</span><br><span class="line">│   ├── models.py</span><br><span class="line">│   ├── tests.py</span><br><span class="line">│   └── views.py</span><br><span class="line">├── Django</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── __pycache__</span><br><span class="line">│   │   ├── __init__.cpython-36.pyc</span><br><span class="line">│   │   └── settings.cpython-36.pyc</span><br><span class="line">│   ├── settings.py</span><br><span class="line">│   ├── urls.py</span><br><span class="line">│   └── wsgi.py</span><br><span class="line">└── manage.py</span><br></pre></td></tr></table></figure>
<ol>
<li><a href="http://manage.py" target="_blank" rel="noopener">manage.py</a>：环境检测和服务启动</li>
<li>AppName：目录就是我们创建的App
<ul>
<li>migrations：自动生成迁移文件</li>
<li><a href="http://app.py" target="_blank" rel="noopener">app.py</a>：创建app配置</li>
<li><a href="http://models.py" target="_blank" rel="noopener">models.py</a>：创建数据库模型</li>
<li><a href="http://test.py" target="_blank" rel="noopener">test.py</a>：写测试程序</li>
<li><a href="http://urls.py" target="_blank" rel="noopener">urls.py</a>：注册路由，从views中导入</li>
<li><a href="http://views.py" target="_blank" rel="noopener">views.py</a>：定义路由</li>
</ul>
</li>
<li>主框架
<ul>
<li>__init__.py：传入pymysql模块，伪装成MySQLdb</li>
<li><a href="http://settings.py" target="_blank" rel="noopener">settings.py</a>：注册app、模板、数据库，设置路径等</li>
<li><a href="http://wsgi.py" target="_blank" rel="noopener">wsgi.py</a>：连通Client和Application</li>
</ul>
</li>
<li>static：静态文件文件夹</li>
</ol>
<p>如果使用静态文件夹，需要在settings.py里面注册静态文件目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">'static'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>如果在pycharm里创建Django项目，会自动生成Templates文件加，用来存放模板文件，不过我们也可以自行创建文件夹标记为模板文件夹</p>
<h2 id="数据库交互">数据库交互</h2>
<p>Django是内置ORM模块的框架，也内置了迁移系统，还内置了shell，迁移系统可以和shell结合，用命令行完成更多功能。</p>
<h3 id="迁移系统的使用">迁移系统的使用</h3>
<p>Django不需要将书库模型导入到设置里面，执行迁移命令时，会自动创建数据库</p>
<ol>
<li>生成迁移文件  <code>python manage.py makemigrations</code></li>
<li>执行迁移文件  <code>python manage.py migrate</code></li>
</ol>
<p>会在migration文件夹里面生成迁移文件，差量更新，如果需要对数据库做大量的改动，或者删除数据表，需要将迁移文件删除，然后将库中的migration表中的迁移条目删除，再进行迁移。</p>
<p>迁移系统用很多shell命令，用<code>python manage.py --help</code>来查看命令，一般用在测试和调试中，建完模型后测试数据库的功能，或错误复现。</p>
<h3 id="驱动">驱动</h3>
<p>Django默认的数据库是sqlite，如果使用sqlite，数据库配置不需要改动，可以自定义数据库名字，如果使用mysql等其他数据库需要，做相应配置，下面是mysql的三个数据库引擎比较</p>
<p>mysqlclient：</p>
<p>对python2,3都支持，但是对mysql的安装有要求，他的驱动需要获取mysql的配置文件mysql.cnf</p>
<p>mysql-python：</p>
<p>只支持python2不支持python3</p>
<p>pymysql：</p>
<p>支持python2,3，pymysql可以伪装成mysqlclient，在主框架下的__init__.py里面添加代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymsql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
<p>在框架的settings.py中配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'HelloDjango'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'000000'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'localhost'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="orm">ORM</h3>
<p>数据库的CRUD，除了创建都是基于查询的。Django创建对象时，不会直接对数据库进行操作，对磁盘的频繁擦写，会降低程序的运行性能，Django会将生成对象的SQL语句保存在缓存中，调用save方法时，才会对数据库进行操作时。</p>
<ol>
<li>create</li>
</ol>
<p>原生Django要在数据模型中封装类方法来创建对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls, name, age)</span>:</span></span><br><span class="line">    user = UserModel.objects.create(u_name=name, u_age=age)</span><br><span class="line">    <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure>
<p>然后调用这个方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = UserModel(u_name=<span class="string">'Tom'</span>, u_age=<span class="number">23</span>)</span><br><span class="line">user.save()</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>retrieve</li>
</ol>
<p>Django默认的查询管理器是<code>objects</code>，查询方法</p>
<ul>
<li>
<p>过滤器</p>
<ul>
<li>filter    筛选出符合条件的结果</li>
<li>exclude    筛选出不符合条件的结果</li>
</ul>
</li>
<li>
<p>get</p>
<ul>
<li>查询条件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Django中不允许字段名中包含双下划线，他的双下划线被用来标记筛选条件中的运算符</span></span><br><span class="line"><span class="comment"># 在筛选条件中如果需要两个下划线来标记，只是获取字段值需要加引号</span></span><br><span class="line">user = UserModel.objects.get(u_age__gt=<span class="number">50</span>).order_by(<span class="string">"u_id"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>get是双刃剑
<ul>
<li>如果精准匹配到一个元素，可以正常返回</li>
<li>如果没有匹配到结果会跑出DoesNotExist错误</li>
<li>如果匹配到多个结果，会抛出MutipleObjectsReturned错误</li>
</ul>
</li>
<li>all
<ul>
<li>返回全部查询结果</li>
</ul>
</li>
<li>first
<ul>
<li>不需要条件，返回查询集中的第一个元素，即第一数据</li>
</ul>
</li>
<li>last
<ul>
<li>不需要条件，返回查询集中的最后一个元素，即最后一条数据</li>
</ul>
</li>
<li>count
<ul>
<li>返回当前查询集中的对象的个数，通常配合其他查询来使用</li>
</ul>
</li>
<li>exist
<ul>
<li>判断查询集中是否有数据，有返回True，否则返回False</li>
</ul>
</li>
</ul>
</li>
<li>
<p>限制查询</p>
<ul>
<li>查询限制可以用一个区间来写，前一个数字相当于<code>offset()</code>，后一个数字相当于<code>limit()</code>，下标不能为负数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">games = Game.objects.filter(g_price__gt=<span class="number">50</span>).filter(g_price__lt=<span class="number">80</span>)</span><br><span class="line"><span class="comment"># offset(2)   limit(3)----5 - 2</span></span><br><span class="line">games = games[<span class="number">2</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>query属性</p>
<ul>
<li>按照查询的结果，输出SQL语句</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">games = Game.objects.filter(g_price__gt=<span class="number">50</span>).filter(g_price__lt=<span class="number">80</span>)</span><br><span class="line"><span class="comment"># 打印转换的SQL语句</span></span><br><span class="line">print(games.query)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>比较运算符</p>
<ul>
<li>大小写敏感，在前面加上<code>i(ignore)</code>，可以取消大小写敏感</li>
<li>exact    精准判断，大小写敏感
<ul>
<li><code>UserModel.objects.filter(user__u_name__exact='tomm')</code></li>
</ul>
</li>
<li>contains    判断是否包含，大小写敏感
<ul>
<li><code>filter(sname__contains='赵')</code></li>
</ul>
</li>
<li>startwith，endwith    以value开头或结尾，大小写敏感
<ul>
<li><code>filter(u_name__startwith='A')</code></li>
</ul>
</li>
<li>in    是否包含在范围内
<ul>
<li><code>filter(pk__in=[2, 4, 6, 8])</code></li>
</ul>
</li>
<li>like    像，形如，可以用正则匹配
<ul>
<li><code>filter(u_name__like('vic*'))</code>   以vic开头</li>
</ul>
</li>
<li>gt, gte, lt, lte    大于，大于等于，小于，小于等于
<ul>
<li><code>filter(u_age__gt=30)</code></li>
</ul>
</li>
<li>order_by    通过什么排序
<ul>
<li>元素前面加<code>-</code>表示逆序</li>
<li><code>UserModel.objects.get(u_age__gt=50).order_by(&quot;u_id&quot;)</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>时间参数</p>
<ul>
<li>year, month, day, week_day, hour, minute, second</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.filter(b_publish_date__year=<span class="number">2020</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>聚合函数</p>
<ul>
<li>Avg    平均值</li>
<li>Count    统计</li>
<li>Max    最大</li>
<li>Min    最小</li>
<li>Sum    求和</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># aggregate为获取的集合，在集合中使用聚合函数，求出最大年龄的用户</span></span><br><span class="line">UserModel.objects(),aggregate(Max(<span class="string">"u_age"</span>))</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>F对象和Q对象</p>
<ul>
<li>F对象，对两个属性进行比较，因为活驴条件必须有两个下划线来标记才合法，在查询中如果有两个需要比较的值，不能同时存在两个双下划线，就需要用到F对象，合法化这个属性，同时进行其他算数运算</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用F对象来比较两个属性的大小</span></span><br><span class="line">grades = Grade.objects.filter(g_girl_num__gt=F(<span class="string">"g_boy_num"</span>))</span><br><span class="line"><span class="comment"># 获取属性后，通过F对象来对属性来进行算数运算</span></span><br><span class="line">grades = Grades.object.filter(g_girl_num__gt=F(<span class="string">"g_boy_num"</span>+<span class="number">50</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>Q对象，支持与或非的关键参数查询，用来判断过滤条件中的属性</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 与：&amp;    或：|    非：～</span></span><br><span class="line"><span class="comment"># 获取年龄小于25的用户</span></span><br><span class="line">UserModel.objects.filter(Q(u_age__lt=<span class="number">25</span>))</span><br><span class="line"><span class="comment"># 获取年龄不小于25的用户</span></span><br><span class="line">UserModel.objects.filter(~Q(u_age__lt=<span class="number">25</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="3">
<li>
<p>update</p>
<p>基于查询：</p>
<ol>
<li>查询对象</li>
<li>修改属性</li>
<li>对象.save()</li>
</ol>
</li>
<li>
<p>delete</p>
<p>基于查询：</p>
<ol>
<li>查询对象</li>
<li>查询到的对象</li>
<li>对象.delete</li>
</ol>
</li>
</ol>
<h1 id="模型models">模型Models</h1>
<h2 id="数据模型">数据模型</h2>
<h3 id="模型的字段类型">模型的字段类型</h3>
<ul>
<li>CharField(max_length=)：字符串类型，参数为长度</li>
<li>Boolean field()：布尔类型</li>
<li>DateField()：日期类型，年月日</li>
<li>DateTimeField()：时间类型，年月日时分秒
<ul>
<li>auto_now_add：第一次创建的时候赋值</li>
<li>auto_now：每次修改时候赋值</li>
</ul>
</li>
<li>AutoField()：自增类型</li>
<li>IntegerField()：整数类型</li>
<li>FloatField()：浮点数类型</li>
<li>FileField()：文件类型</li>
<li>ImageField(upload_to=)图片类型，存储路径，参数是路径
<ul>
<li>依赖于<code>pillow</code>模块</li>
<li>设置<code>MEDIA_ROOT</code></li>
</ul>
</li>
<li>TextField()：文本类型</li>
<li>DecimalField()：固定精度小数
<ul>
<li>max_digits：总位数</li>
<li>decimal_places：小数后几位</li>
</ul>
</li>
</ul>
<p>MEEDIA_ROOT的设置，例如存储用户头像icon，在settings.py中添加其路径：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">'static/icons'</span>)</span><br></pre></td></tr></table></figure>
<p>在模型中定义字段类型和限制为image文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModel</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="comment"># upload_to=后面是根据时间生成的路径，在静态文件文件夹里面</span></span><br><span class="line">    icon = models.ImageField(upload_to=<span class="string">"%Y-%M-%D"</span>)</span><br></pre></td></tr></table></figure>
<p>当然，我们也可以不用<code>ImageField()</code>属性，自定义存储的位置，然后将路径存储到数据库中</p>
<h3 id="模型参数">模型参数</h3>
<ul>
<li>default：默认值</li>
<li>null：是否为空，存储有关，创建记录时可以不传值，用NULL填充</li>
<li>blank：是否为空，校验有关，创建记录时可以为空字符串，不允许前端传空字符串，否则400</li>
<li>primary_key：主键，有自增属性</li>
<li>unique：唯一约束，可以有多个null</li>
</ul>
<h3 id="属性">属性</h3>
<p>数据模型的属性分为显性属性和隐形属性</p>
<p><strong>显性属性</strong>包括开发主动声明的模型的属性和方法，还有从父类中继承来的属性和方法。</p>
<p><strong>隐性属性</strong>是开发这未声明，自动生成的属性，开发者声明了就不自动生成了</p>
<p>例如模型的objects属性，是一个隐性属性，不需要开发者声明，自动生成，直接调用进行查询过滤，是一个manager实例，用来创建管理模型。</p>
<p>重写这个实例，实现对数据库数据的过滤，使返回的结果只包含没有被逻辑删除的结果。首先创建一个新的manager类，继承自Manager，重写他的<code>get_queryset()</code>方法，实现过滤功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LearnManager</span><span class="params">(Manager)</span>:</span></span><br><span class="line">    <span class="comment"># 重写查询结果集，对数据进行过滤</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        queryset = super().get_queryset().filter(is_delete=Flase)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_goods</span><span class="params">(self, g_name, g_price=<span class="number">10</span>)</span>:</span></span><br><span class="line">        goods = self.model()</span><br><span class="line">        goods.g_name = g_name</span><br><span class="line">        goods.g_price = g_price</span><br><span class="line">        goods.save()</span><br><span class="line">        <span class="keyword">return</span> goods</span><br></pre></td></tr></table></figure>
<p>针对数据的逻辑删除，需要在模型中定义一个删除的属性<code>is_delete</code>，删除是直接操作这个属性，我们在模型中定义这个删除的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Goods</span><span class="params">(model.Model)</span>:</span></span><br><span class="line">    is_delte = models.BooleanField(default=<span class="literal">False</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, using=None, keeo_parents=False)</span>:</span></span><br><span class="line">        self.is_delete = <span class="literal">True</span></span><br><span class="line">        self.save()</span><br><span class="line">    <span class="comment"># 重新定义objects为我盟的模型管理器的实例</span></span><br><span class="line">    goods_manager = LearnManager()</span><br></pre></td></tr></table></figure>
<p>这样我们的模型就有了一个新的模型管理器goods_manager</p>
<p>在views中使用管理器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有没有被逻辑删除的数据</span></span><br><span class="line">goods = Goods.goods_manager.all()</span><br></pre></td></tr></table></figure>
<h2 id="数据关系">数据关系</h2>
<p>数据之间的管理是认为定义的，分为一对一，一对多，多对多，一对一可以通过数据表中唯一的外键来实现，一对多可以使用不唯一的外键实现，多对对则需要创建一个新的关系表，来表示两个表之间数据的关系</p>
<h3 id="一对一">一对一</h3>
<p>使用场景，业务拆分时，对现有的表进行拆分，或者对项目扩充，增加字段，直接操作现有表，可能会出现错误，造成无法晚会的损失，创建一个扩展的表是理想的解决方案，可以通过给外键添加唯一约束来实现一对一的关系，例如<code>g_foo = models.ForeignKey(User, unique=True)</code>，Django里面自带一个OneToOneField属性用来实现一对一的关系映射。</p>
<p>当操作数据库时，删除主表的内容，从表的数据也会被级联删除，删除从表数据，主表不会受影响。<strong>谁声明的一对一关系，谁就是从表</strong></p>
<p>我们假定有两张表，一张用户表UserModel，一张用户权限表VipModel，用户表是主表，权限表是从表。声明关系语句为<code>v_user = models.OneToOneField(User, on_delete=models.SET_NULL, null=True)</code>。SET_NULL可以为空。</p>
<p><strong>一对一中的属性</strong>：主表获取从表的值，是隐形属性，获取要用模型名，根据用户表获取最后一个用户在权限表中的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user = UserModel.objects.last()</span><br><span class="line"><span class="comment"># 对象.关联模型（模型名要小写）获取到一条vip数据</span></span><br><span class="line">vip = user.vipmodel</span><br></pre></td></tr></table></figure>
<p>根据从表获取主表信息是显性属性，直接按字段名就可以获取。如果要获取第一个vip的用户名，则通过权限表，获取用户表的字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vip = VipModel.objects.first()</span><br><span class="line"><span class="comment"># 对象.字段（字段是vip表中的，获取到用户对象）</span></span><br><span class="line">user = vip.v_user</span><br></pre></td></tr></table></figure>
<h3 id="一对多">一对多</h3>
<p>一对多的关系和一对一基本一致，使用ForeignKey来实现，默认删除主表数据，从表的数据会被级联删除，可以设置保护模式，使其不被删除。SET_PROTECT</p>
<p>假定我们有一个人的表，一个爱好的表，人的表是主表，定义模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 人</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    p_name = models.CharField(max_length=<span class="number">30</span>)</span><br><span class="line">    p_age = models.IntegerField(default=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 爱好</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hobby</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    h_name = models.CharField(max_length=<span class="number">30</span>)</span><br><span class="line">    h_cost = models.FloatField(default=<span class="number">1000</span>)</span><br><span class="line">    <span class="comment"># 一对多</span></span><br><span class="line">    h_person = models.ForeignKey(Person, on_delete=models.PROTECT)</span><br></pre></td></tr></table></figure>
<p>获取级联数据，Django会自动生成一个从表的<code>模型_set</code>管理器，获取从表数据通过它来获取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从获取主，显性属性， 对象.字段名</span></span><br><span class="line">hobby = Hobby.objects.last()</span><br><span class="line">person = hobby.h_person     <span class="comment"># 爱好对应的人</span></span><br><span class="line"><span class="comment"># 主获取从，隐性属性， 对象.关联模型_set  [与objects同源，所以用法也是一致]</span></span><br><span class="line">person = Person.objects.last()</span><br><span class="line"><span class="comment"># hobby_set与objects同源，all表示所有数据</span></span><br><span class="line">hobbies = person.hobby_set.all()  <span class="comment"># 人对应的爱好</span></span><br><span class="line"><span class="comment"># 按条件获取</span></span><br><span class="line">hobbies = person.hobby_set.filter(id=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h3 id="多对多">多对多</h3>
<p>表现出来的是两个数据表之间的映射，通过第三张表来体现，用<code>ManyToManyField</code>来实现，Django会自动创建第三张表关系表，关系表中会存储两张关联表的id，同样，声明关系的表是从表，并且从表不需要认为干涉。</p>
<p>删除数据时，会自动删除关系表中的级联关系数据</p>
<p>我们以用户和商品的关系，来展示级联数据的获取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModel</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    u_name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Goods</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    g_name = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    g_users = models.ManyToManyField(UserModel)</span><br></pre></td></tr></table></figure>
<p>数据的操作，查询时获取的数据都是负数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据查询</span></span><br><span class="line"><span class="comment"># 从表获取主表，是显性属性：对象.字段名</span></span><br><span class="line">goods = Goods.object.last()</span><br><span class="line">user = goods.g_user.all()</span><br><span class="line"><span class="comment"># 主表获取从表，是隐形属性：对象.从表_set</span></span><br><span class="line">user = UserModel.objects.first()</span><br><span class="line">goods = user.Goods_set.all()</span><br><span class="line"><span class="comment"># 数据改动</span></span><br><span class="line">goods = Goods.objects.first()</span><br><span class="line">user = UserModel.objects.last()</span><br><span class="line">user.goods_set.add(goods)  <span class="comment"># goods_set是自动生成的模型管理器</span></span><br><span class="line">goods.g_user.remove(user)</span><br><span class="line">goods.g_user.clear()  <span class="comment"># 清楚所有关系数据</span></span><br></pre></td></tr></table></figure>
<h3 id="删除模式">删除模式</h3>
<p>在声明级联关系的字段中增加’on_delete=xxx’属性，包含以下几个值<br>
写法例如（多对多的关系中没有on_delete属性）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v_user = models.OneToOneField(UserModel, on_deletr=models.SET_NULL, null=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>models.CASECADE：默认模式，默认删除级联数据</li>
<li>models.DO_NOTHING：删除关联数据，什么都不做</li>
<li>models.PROTECT：保护模式，存在级联数据时，删除会报异常</li>
<li>models.SET_XXX
<ul>
<li>SET_NULL：主表级联数据被删时置空（需要指定允许为空）</li>
<li>SET_DEFAULT：主表级联数据被删设为默认值（指定默认值）</li>
<li>SET()：删除时重新指向一个实体对象元素
<ul>
<li>SET(value)：删除关联的数据设为指定的值</li>
<li>SET(可执行对象)：关联值设置为可执行对象的返回值</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="模型继承">模型继承</h2>
<p>我们所创建的models模型，本身就是继承自models.Model，同样，我们也可以自己定义一个model作为基础父类，把通用的数据存储在父类的模型中。</p>
<p>如果直接迁移，数据库中也会直接生成父类的表，可以在基础模型中定义一个属性<code>class Meta:</code>，来抽象化基础模型。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    id = models.IntegerField(primary_key=<span class="literal">True</span>, unique=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        abstract = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>定义abstract属性之后，基础模型就不会在数据库中生成映射</p>
<h2 id="模型和库转换">模型和库转换</h2>
<p>models --&gt; db</p>
<p>迁移模型生成数据表</p>
<p>db --&gt; models</p>
<p>把数据表映射到模型文件中</p>
<p><code>python manage.py insectdb &gt; models.py</code></p>
<p>环境转移：</p>
<ol>
<li>导出所有依赖</li>
</ol>
<p><code>pip freeze &gt; requirements.txt</code></p>
<ol start="2">
<li>安装所有依赖</li>
</ol>
<p><code>pip install -r requirements.txt</code></p>
<h1 id="模板templates">模板Templates</h1>
<h2 id="模板文件夹">模板文件夹</h2>
<p>Templates文件夹存放模板文件，可以使用模板语法，<strong>注意static文件夹里面html文件不能使用模板语法</strong>。</p>
<p>Templates可以是自定义的名字，在子应用目录下需要注册，在工程目录下需要在<code>settings.py</code>里注册，然后将文件夹标记为Template Folter。</p>
<p>Django默认的模板配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line">        <span class="string">'DIRS'</span>: [os.path.join(BASE_DIR, <span class="string">'templates'</span>)],</span><br><span class="line">        ...</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在views里面返回需要渲染在返回，用<code>render()</code>方法，<code>return render(request, 'Template.html', locals())</code></p>
<h2 id="模板语法">模板语法</h2>
<h3 id="结构标签">结构标签</h3>
<ul>
<li>
<p>block</p>
<ul>
<li>定义一个块，子类标签中引用。</li>
</ul>
</li>
<li>
<p>extends</p>
<ul>
<li>
<p>加载父类的html文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>include</p>
<ul>
<li>尽量不要使用</li>
</ul>
</li>
</ul>
<p>使用block标签来加载静态文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;<span class="comment">&lt;!--不可省略--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--使用block把html代码分割，extCSS是自定义命名--&gt;</span></span><br><span class="line">&#123;% block extCSS %&#125;</span><br><span class="line">    &#123;&#123; block.super &#125;&#125;<span class="comment">&lt;!--继承父类block的内容--&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>使用block + extends，化零为整，include由零化一</p>
<p>父标签base.html中定义一个block</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block header %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">h3</span>&gt;</span></span><br><span class="line">        this is a header block</span><br><span class="line"><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>在子标签home.html中继承</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">&#123;# 这是一个模板注释，网页中检查元素是不可见的 #&#125;</span><br><span class="line">&#123;% 这是一个多行模板注释，也是不可见的。默认子标签的内容会覆盖付标签的内容，通过super来继承福标签内容 %&#125;</span><br><span class="line">	&#123;&#123; block.supper&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span></span><br><span class="line">    this is a child html</span><br><span class="line"><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="变量语法">变量语法</h3>
<p>使用点语法来获取变量，在视图中返回json或者字典数据，在标签中通过key来获取。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; params &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; param.name &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 获取列表里面的单个元素，这里是一个用户对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; user_list.1 &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 获取对象的属性 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; user_list.2.name &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 可以在试图函数里面使用__str__将对象转化为字符串 --&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用点语法来引用对象方法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>biger:&#123;&#123; dic.name.upper&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="标签语法">标签语法</h3>
<p>形如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tag %&#125;</span><br></pre></td></tr></table></figure>
<p>的语句，就是Django的标签语法，可以实现复杂的逻辑，一些标签需要开始和结束标签</p>
<ol>
<li>for循环</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>循环取值1<span class="tag">&lt;/<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">&#123;% for item in person_list %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; item.name&#125;&#125;,&#123;&#123; item.age&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 一个可选的empty标签，如果没有元素是展示 --&gt;</span></span><br><span class="line">&#123;% empty %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>sorry,no person here<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>循环取值2:倒序<span class="tag">&lt;/<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">&#123;% for item in person_list reversed %&#125;</span><br><span class="line">    <span class="comment">&lt;!--序号从1开始--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; forloop.counter&#125;&#125;-----&gt;&#123;&#123; item.name&#125;&#125;,&#123;&#123; item.age&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--序号从0开始--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; forloop.counter0&#125;&#125;-----&gt;&#123;&#123; item.name&#125;&#125;,&#123;&#123; item.age&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 序号倒序 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; forloop.revcounter&#125;&#125;-----&gt;&#123;&#123; item.name&#125;&#125;,&#123;&#123; item.age&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>循环取值3：字典<span class="tag">&lt;/<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">&#123;% for k,v in d.items %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; k&#125;&#125;,&#123;&#123; v&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>if标签</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if i &gt; 300 %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>大于&#123;&#123; i&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% elif i == 200 %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>等于&#123;&#123; i&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>小于&#123;&#123; i&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>with标签</li>
</ol>
<p>使用一个简单地名字缓存一个复杂的变量，当你需要使用一个“昂贵的”方法（比如访问数据库）很多次的时候是非常有用的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% with total=business.employees.count %&#125;</span><br><span class="line">	<span class="comment">&lt;!-- 复数显示及国际化使用pluralize --&gt;</span></span><br><span class="line">    &#123;&#123; total&#125;&#125; employee&#123;&#123; total|pluralize&#125;&#125;</span><br><span class="line">&#123;% endwith %&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>csrf_token</li>
</ol>
<p>用来标记跨站请求伪造保护</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% csrf_token %&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>转义开关</li>
</ol>
<p>作用：views.py传过来的字典值是一串html代码，默认是按字符串输出的，如果转义后则会编译成html格式在页面输出</p>
<ul>
<li>safe方法转义</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; contents|safe &#125;<span class="comment">&lt;!--添加safe完成转义，不建议--&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>包裹起来转义</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--off是关闭转义，on是开启--&gt;</span></span><br><span class="line">&#123;% autoescape off %&#125;</span><br><span class="line">  &#123;&#123; content &#125;&#125;  </span><br><span class="line">&#123;% endautoescape %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="渲染模板">渲染模板</h2>
<p>模板渲染返回，可以使用render方法，也可以使用<strong>HttpResponse</strong>来实现render的功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先加载模板文件</span></span><br><span class="line"><span class="comment"># 返回&lt;class 'django.template.backends.django.Template'&gt;</span></span><br><span class="line">template = loader.get_template(<span class="string">'Hello.html'</span>)</span><br><span class="line"><span class="comment"># 渲染模板</span></span><br><span class="line">result = template.render(context=&#123;<span class="string">"msg"</span>: <span class="string">"okba"</span>&#125;)</span><br><span class="line"><span class="comment"># 用HttpResponse返回</span></span><br><span class="line"><span class="keyword">return</span> HttpResponse(result)</span><br></pre></td></tr></table></figure>
<h1 id="视图view">视图View</h1>
<h2 id="request">request</h2>
<p>request是Django框架根据Http请求报文生成的对象，包含了请求的所有信息，默认是视图函数的第一个参数</p>
<p>组成属性：</p>
<ul>
<li>path：请求页面的完整地址，不包括域名</li>
<li>method：请求方法，大写，‘GET’, ‘POST’</li>
<li>GET：类字典对象，包含GET参数信息</li>
<li>POST：类字典对象，包含POST参数信息，可能为空</li>
<li>request：为了方便而创建，类字典对象，先搜索POST，然后GET，在高版本去除</li>
<li>cookies：标准Python字典，包含所有cookies</li>
<li>FILES：类字典对象，包含所上传的文件。
<ul>
<li>name：字符串上传文件的名</li>
<li>content-type：文件的内容类型</li>
<li>content：文件的原始内容</li>
</ul>
</li>
<li>META：标准Python字典，包含所有HTTP头信息，完整地址，端口，语言，编码等
<ul>
<li>REMOTE_ADDR</li>
</ul>
</li>
<li>session：可读写的类字典对象，仅当激活session时有效</li>
<li>is_ajax：是否是ajax请求</li>
</ul>
<p>几个方法：</p>
<ul>
<li>__getitem__(key)：获取所给键的GET/POST值，先查找POST，然后GET，不存在则跑出keyerror</li>
<li>has_key()：<code>request.POST.has_key()</code>，返回布尔值，是否包含所给的键</li>
<li>get_full_path()：返回path，若请求参数有效，则会附带请求参数</li>
<li>is_secure()：如果请求是HTTPS请求，返回True</li>
</ul>
<p>QueryDict对象，是一个类似字典的类，被设计成可以处理同一个键有多个值的情况。它的实例是一个不可变对象，也就是说不能改变request.POST或者request.GET的值</p>
<ul>
<li>
<p>__getitem__(key)：返回给定键的值，有多个就返回最后一个值</p>
</li>
<li>
<p>get(key, default)：获取键的值，如果不存在返回默认值，类似于__getitem__()</p>
</li>
<li>
<p>getlist(key)：获取键对应值的列表</p>
</li>
</ul>
<h2 id="处理文件">处理文件</h2>
<p>request请求上传的文件包含在FILES里面，键来自<code>&lt;input type=&quot;file&quot; name=&quot;&quot;/&gt;</code>中的name，只在POST请求中存在，并且提交的<code>&lt;form&gt;</code>包含entype=&quot;multipart/form-data&quot;时才生效，否则FILES只是一个空的类字典对象。</p>
<p>以图像为例，展示一个文件的上传和存储的过程。首先在视图函数中接受这个文件，具体实现的思路是，将文件拆分成小块的可迭代对象，然后将其写入到文件里面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> DjangoView.settings <span class="keyword">import</span> MEDIA_ROOT</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method = <span class="string">"POST"</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">"username"</span>)</span><br><span class="line">        icon = request.FILES.get(<span class="string">"icon"</span>)</span><br><span class="line">        save_filename = os.path.join(MEDIA_ROOT, icon.name)</span><br><span class="line">        <span class="comment"># 用with方法来实现文件存储</span></span><br><span class="line">        <span class="keyword">with</span> open(save_filename, <span class="string">"wb"</span>) <span class="keyword">as</span> save_file:</span><br><span class="line">            <span class="comment"># chunks 将文件拆分差成块的可迭代对象</span></span><br><span class="line">            <span class="keyword">for</span> part <span class="keyword">in</span> icon.chunks():</span><br><span class="line">                save_file.write(part)</span><br><span class="line">                save_file.flush()</span><br><span class="line">        user = User(username=username, icon=save_filename)</span><br><span class="line">        user.save()</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"upload file"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="会话技术">会话技术</h2>
<h3 id="cookie">cookie</h3>
<p>通过返回方法生成的实例来设置cookie，分为加盐和不加盐，加盐的cookie更安全</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resp = HttpResponse(<span class="string">"content"</span>)</span><br><span class="line"><span class="comment"># 设置cookie</span></span><br><span class="line">resp.set_cookie(<span class="string">"key"</span>, <span class="string">"value"</span>, max_age=<span class="string">"过期时间"</span>)</span><br><span class="line"><span class="comment"># 删除cookie</span></span><br><span class="line"><span class="keyword">del</span> request.COOKIES[<span class="string">"key"</span>]  <span class="comment"># 删除了服务器的cookie，浏览器还有</span></span><br><span class="line">resp.delete_cookie(<span class="string">"key"</span>)  <span class="comment"># 删除了对应键的值，键还存在</span></span><br><span class="line">resp.flush()  <span class="comment"># 删除所有cookie</span></span><br><span class="line"><span class="comment"># 获取cookie</span></span><br><span class="line">request.COOKIES.get(<span class="string">"key"</span>)</span><br></pre></td></tr></table></figure>
<p>加盐的cookie设置获取和删除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">value = request.POST.get(<span class="string">"name"</span>)</span><br><span class="line">resp = HttpResponse(<span class="string">"redirect to login"</span>)</span><br><span class="line"><span class="comment"># 设置加盐cookie，盐是一个字符串</span></span><br><span class="line">response.set_signed_cookie(<span class="string">"key"</span>, <span class="string">"value"</span>, salt=<span class="string">"String"</span>)</span><br><span class="line"><span class="comment"># 获取加盐cookie，需要提供加的盐</span></span><br><span class="line">value = request.get_signed_cookie(<span class="string">"key"</span>, salt=<span class="string">"String"</span>)</span><br><span class="line"><span class="comment"># 删除加盐cookie</span></span><br><span class="line">resp.delete_cookie(<span class="string">"key"</span>)</span><br><span class="line"><span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>
<p>cookie的参数：</p>
<ul>
<li>key：键</li>
<li>value：值</li>
<li>max_age：过期时间，时间为秒</li>
<li>expires：过期时间，为具体时间</li>
<li>path：生效路径</li>
<li>domain：生效的域名</li>
<li>secure：HTTPS请求时设置为True</li>
<li>httponly：用于http传输，JavaScript无法获取</li>
</ul>
<h3 id="session">session</h3>
<h4 id="默认">默认</h4>
<p>session是数据保存在服务器的回话技术，flask默认将session存在了cookie中，django默认存在了ORM中，在迁移时默认生成一张<code>django-session</code>的表，django将session持久化到了内存中。</p>
<p>主要有三个字段：</p>
<ul>
<li>session_key：唯一</li>
<li>session_data：数据拼接混淆串，跟base64编码的串结合在一起</li>
<li>session_expire：默认过期时间14天</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    username = request.POST.get(<span class="string">"username"</span>)</span><br><span class="line">    <span class="comment"># 设置session</span></span><br><span class="line">    request.session[<span class="string">"username"</span>] = username</span><br><span class="line">    <span class="comment"># 获取session的值</span></span><br><span class="line">    username = request.session.get(<span class="string">"username"</span>)</span><br><span class="line">    <span class="comment"># cookie  session 一起干掉</span></span><br><span class="line">    request.session.flush()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"you are in"</span>)</span><br></pre></td></tr></table></figure>
<p>你也可以在模板里面，用模板语法获取到session</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; request.session.username &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="redis">redis</h4>
<p><strong>session实现在redis中存取</strong>借助了一个模块<code>pip install django-redis-sessions</code>，或者在下载页面下载然后<code>python setup.py install</code>，github地址：<a href="https://github.com/martinrusev/django-redis-sessions" target="_blank" rel="noopener">https://github.com/martinrusev/django-redis-sessions</a> ，安装之后需要在settings.py里面设置如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引擎设置</span></span><br><span class="line">SESSION_ENGINE = <span class="string">'redis_session.session'</span></span><br><span class="line"><span class="comment"># 链接设置</span></span><br><span class="line">SESSION_REDIS = &#123;</span><br><span class="line">    <span class="string">'host'</span>: <span class="string">'localhost'</span>,</span><br><span class="line">    <span class="string">'port'</span>: <span class="number">6379</span>,</span><br><span class="line">    <span class="string">'db'</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">'password'</span>: <span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'prefix'</span>: <span class="string">'session'</span>,</span><br><span class="line">    <span class="string">'socket_timeout'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'retry_on_timeout'</span>: <span class="literal">False</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 如果使用远程服务器的redis</span></span><br><span class="line">SESSION_REDIS = &#123;</span><br><span class="line">    <span class="string">'unix_domain_socket_path'</span>: <span class="string">'/var/run/redis/redis.sock'</span>,</span><br><span class="line">    <span class="string">'db'</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">'password'</span>: <span class="string">'password'</span>,</span><br><span class="line">    <span class="string">'prefix'</span>: <span class="string">'session'</span>,</span><br><span class="line">    <span class="string">'socket_timeout'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'retry_on_timeout'</span>: <span class="literal">False</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>集群的redis需要配置redis哨兵(Redis Sentinel)，即从服务器，也可以设置Redis Pool</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置哨兵信息</span></span><br><span class="line">SESSION_REDIS_SENTINEL_LIST = [(host, port), (host, port), (host, port)]</span><br><span class="line">SESSION_REDIS_SENTINEL_MASTER_ALIAS = <span class="string">'sentinel-master'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置redis池</span></span><br><span class="line">SESSION_REDIS = &#123;</span><br><span class="line">    <span class="string">'prefix'</span>: <span class="string">'session'</span>,</span><br><span class="line">    <span class="string">'socket_timeout'</span>: <span class="number">1</span></span><br><span class="line">    <span class="string">'retry_on_timeout'</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">'pool'</span>: [&#123;</span><br><span class="line">        <span class="string">'host'</span>: <span class="string">'localhost3'</span>,</span><br><span class="line">        <span class="string">'port'</span>: <span class="number">6379</span>,</span><br><span class="line">        <span class="string">'db'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'unix_domain_socket_path'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'url'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'weight'</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'host'</span>: <span class="string">'localhost2'</span>,</span><br><span class="line">        <span class="string">'port'</span>: <span class="number">6379</span>,</span><br><span class="line">        <span class="string">'db'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'unix_domain_socket_path'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'url'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'weight'</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'host'</span>: <span class="string">'localhost1'</span>,</span><br><span class="line">        <span class="string">'port'</span>: <span class="number">6379</span>,</span><br><span class="line">        <span class="string">'db'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'unix_domain_socket_path'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'url'</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">'weight'</span>: <span class="number">1</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好redis的连接，就可以使用redis来存session了，存取的命令没有任何的改变，Django会自动帮我们完成。</p>
<h3 id="cache">cache</h3>
<h4 id="默认-v2">默认</h4>
<p>Django是自带缓存系统的，默认将缓存放在的了配置的数据库中，在终端命令行里面可以使用默认命令创建缓存表，<code>python manager.py createcachetable TableName</code>，会在数据库中生成一张自定义名称<code>TableName</code>的表，用来存储缓存，包含三个参数，都不允许为空</p>
<ul>
<li>cache_key</li>
<li>value</li>
<li>expires</li>
</ul>
<p>需要在settings.py中配置缓存数据库：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.db.DatabaseCache'</span>,</span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'TableName'</span>,</span><br><span class="line">        <span class="string">'TIMEOUT'</span>: <span class="string">'60'</span>,</span><br><span class="line">        <span class="string">'KEY_PREFIX'</span>: <span class="string">'Prefix'</span>,</span><br><span class="line">        <span class="string">'VERSION'</span>: <span class="string">'1'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缓存的存取：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line">resp = render(request, <span class="string">"person_list.html"</span>, locals())</span><br><span class="line"><span class="comment"># 设置缓存</span></span><br><span class="line">cache.set(<span class="string">"persons"</span>, resp, timeout=<span class="number">60</span>*<span class="number">5</span>)</span><br><span class="line"><span class="keyword">return</span> resp</span><br><span class="line"><span class="comment"># 获取缓存</span></span><br><span class="line">result = cache.get(<span class="string">"persons"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="redis-v2">redis</h4>
<p>用redis来实现缓存是非常理想的方式，Django中配置redis作为缓存数据库，需要用到<code>django-redis</code>，或者<code>django-redis-cache</code>模块，配置基本一直，以django-redis为例</p>
<p>虚拟环境输入<code>pip install django-redis</code>，然后在settings.py里面配置缓存：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://127.0.0.1:6379/1"</span>,</span><br><span class="line">        <span class="string">"OPTIONS"</span>: &#123;</span><br><span class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</span><br><span class="line">             <span class="comment"># "PASSWORD": "密码",</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缓存的存取写法不变。</p>
<p>我们也可以使用redis实现全站缓存，来提高服务器的运行效率。 使用中间件，经过一系列的认证等操作，如果内容在缓存中存在，则使用FetchFromCacheMiddleware获取内容并返回给用户，<br>
当返回给用户之前，判断缓存中是否已经存在，如果不存在则UpdateCacheMiddleware会将缓存保存至缓存，从而实现全站缓存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 中间件</span></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'django.middleware.cache.UpdataCacheMiddleware'</span>,</span><br><span class="line">    <span class="comment"># 其他中间件</span></span><br><span class="line">    <span class="string">'django.middleware.cache.FetchFromCacheMeddileware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>缓存可以在单独的视图中使用</p>
<p>方法一：通过装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"></span><br><span class="line"><span class="meta">@cache_page(60 * 15)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    username = cache.get(<span class="string">"username"</span>)</span><br></pre></td></tr></table></figure>
<p>方法二：通过url</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^login/'</span>, cache_page(<span class="number">60</span> * <span class="number">15</span>)(login)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="分页器">分页器</h2>
<p>Django自带了一个分页器Paginator，帮助我们实现多条数据的展示，当我们实例化一个Paginator类的实例时，需要给Paginator传入两个参数，第一个是<strong>一个列表、元组或者查询结果集QuerySet</strong>，第二个是<strong>每页显示的数据，是一个整数</strong></p>
<p>Paginator类中有三个常用属性：</p>
<ul>
<li>count：表示所有页面对象的总数</li>
<li>num_page：表示页面总数</li>
<li>page_range：下表从1开始的页面范围迭代器</li>
</ul>
<p>Page对象：Paginator类提供一个**page(number)**函数，该函数返回的就是一个page对象，number表示第几个分页，在前端显示数据时，主要的操作都是基于Page()对象的。</p>
<p>Page对象有三个常用的属性：</p>
<ul>
<li>object_list：表示当前页面上所有对象的列表</li>
<li>numberv：表示当前也的序号，从1开始计数</li>
<li>paginator：当前Page对象所属的Paginator对象</li>
</ul>
<p>Page对象还拥有几个常用的函数：</p>
<ul>
<li>has_next()：判断是否有下一页，有就返回True</li>
<li>has_previous()：判断是否有上一页，有就返回True</li>
<li>has_other_pages()：判断是否有上一页或下一页，有就返回True</li>
<li>next_page_number()：返回下一页的页码，如果下一页不存在抛出InvalidPage 异常</li>
<li>previous_page_number()：返回上一页页码，如果上一页不存在抛出InvalidPage 异常</li>
</ul>
<p>在view视图中，获取前端传过来的页面数据，包括页码数，每页条数，从数据库中查询数据，构建分页器，生成响应</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">person_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    page = int(request.GET.get(<span class="string">"page, 10"</span>))</span><br><span class="line">    per_page = int(request.GET.get(<span class="string">"per_page"</span>))</span><br><span class="line">    persons = Person.objects.all()</span><br><span class="line">    <span class="comment"># 构建分页器</span></span><br><span class="line">    paginator = Paginator(persons, per_page)</span><br><span class="line">    <span class="comment"># 前一步已经生成了全部的页面，我们直接获取具体的某一页</span></span><br><span class="line">    page_object = paginator.page(page)</span><br><span class="line">    <span class="comment"># 生成响应</span></span><br><span class="line">    response = render(request, <span class="string">"person_list.html"</span>, locals())</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p>在html里面接受传入的页面数据</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--用传过来的页面数据生成无序列表--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for person in page_object.object_list %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面展示的是页码的生成，通过判断是否有前页后页，在第一和最后页时，将按钮变为不可点击状态。用到了bootstrap和后面要讲的反向解析</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination"</span>&gt;</span></span><br><span class="line">        &#123;% if page_object.has_previous %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'two:persons' %&#125;?page=&#123;&#123; page_object.previous_page_number &#125;&#125;&amp;per_page=&#123;&#123; per_page &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">aria-label</span>=<span class="string">"Previous"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"disabled"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">aria-label</span>=<span class="string">"Previous"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">        &#123;% for page_num in paginator.page_range %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'two:persons' %&#125;?page=&#123;&#123; page_num &#125;&#125;&amp;per_page=&#123;&#123; per_page &#125;&#125;"</span>&gt;</span>&#123;&#123; page_num &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        &#123;% if page_object.has_next %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'two:persons' %&#125;?page=&#123;&#123; page_object.next_page_number &#125;&#125;&amp;per_page=&#123;&#123; per_page &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">aria-label</span>=<span class="string">"Next"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>&amp;raquo;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"disabled"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">aria-label</span>=<span class="string">"Next"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>&amp;raquo;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="中间件">中间件</h2>
<p>Django中的中间件也是面向切面编程的一种，注册在settings.py中的中间件会按照顺序加载执行，是django内置的一个底层插件，本质上是MiddlewareMixin的子类，是一个类装饰器，调用<code>__call__</code>方法。</p>
<p>我们可以用中间件来实现类似于记录、日志、用户认证、黑白名单、优先级、拦截器、反爬虫等功能</p>
<p>内置的切点：</p>
<ul>
<li>process_request</li>
<li>process_view</li>
<li>process_template_response</li>
<li>process_response</li>
<li>process_exception
<ul>
<li>界面友好化</li>
<li>错误记录</li>
</ul>
</li>
</ul>
<p>首先创建一个middleware的package，在理编写我们的功能代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="comment"># 重写process_request方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(request.path)</span><br><span class="line">    <span class="comment"># 重写process_exception方法，出异常时重定向至首页</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, excception)</span>:</span></span><br><span class="line">        print(exception)</span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">"app:index"</span>))</span><br></pre></td></tr></table></figure>
<p>然后在settings.py里面注册中间件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'middleware.LearnMiddlw.CustomMiddleware'</span>,</span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="返回response">返回Response</h2>
<h3 id="httpresponse">HttpResponse</h3>
<p>相对与HttpRequest来说，HttpRequest是Django根据request自动创建的，而HttpResponse是开发者自己创建的，我们编写的每个视图都要实例化、填充和返回一个HttpResponse对象。也就是函数的return值。</p>
<p>可传递的数据：</p>
<ul>
<li>字符串</li>
<li>可迭代对象</li>
<li>设置头部字段</li>
</ul>
<p>1.字符串：最简单的是传递一个定义的字符串返回</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = HttpResponse(<span class="string">"This is a string to return"</span>, content_type(<span class="string">"text/plain"</span>))</span><br></pre></td></tr></table></figure>
<p>也可以将它的实例化对象看做类文件写入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response = HttpResponse()</span><br><span class="line">response.write(<span class="string">"&lt;p&gt;Here is a title for a web page&lt;/p&gt;"</span>)</span><br></pre></td></tr></table></figure>
<p>2.可迭代对象：HttpResponse会立即处理这个迭代器，并把它的内容存成字符串，最后废弃这个迭代器。比如文件在读取后，会立刻调用close()方法，关闭文件。</p>
<p>3.设置头部字段：可以把HttpResponse对象当作一个字典一样，在其中增加和删除头部字段。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response = HttpResponse()</span><br><span class="line">response[<span class="string">"age"</span>] = <span class="number">18</span></span><br><span class="line"><span class="keyword">del</span> response[<span class="string">"age"</span>]</span><br></pre></td></tr></table></figure>
<p>与字典不同的是，如果删除的头部字段不存在的话，会抛出KeyError，且不包含换行（CR、LF），会出现BadHeaderError异常</p>
<p>返回制定的数据类型<code>content_type</code>，是可选的，用于填充HTTP的<code>Content-Type</code>头部。如果未指定，默认情况下由<code>DEFAULT_CONTENT_TYPE</code>和<code>DEFAULT_CHARSET</code>设置组成：<code>text/html; charset=utf-8</code>。</p>
<p><code>content_type</code>可以在MIME（多用途互联网邮件扩展）的概念中找到，他指定一个数据的类型和打开此数据的插件。</p>
<h3 id="jsonresponse">JsonResponse</h3>
<p>是HttpResponse的一个子类，默认<code>content_type = &quot;application/json&quot;</code>，传入的参数是一个字典类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># view视图中</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"ok"</span>,</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">200</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> JsonResponse(data)</span><br></pre></td></tr></table></figure>
<h3 id="redirect">redirect</h3>
<p>重定向，可以根据url、第三方路径、命名空间、对象、视图view重定向</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据url路径</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">"/index/"</span>)</span><br><span class="line"><span class="comment"># 根据第三方路径</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">"heeps://www.cn.bing.com"</span>)</span><br><span class="line"><span class="comment"># 根据命名空间</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">"blog:article_list"</span>))</span><br></pre></td></tr></table></figure>
<p>根据对象重定向，前提是在模型中定义了get_absolute_url()方法，是定义Model的对象的查看地址，主要是用在RSS与后台查看：</p>
<p>在模型models.py中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">	title = models.CharField(<span class="string">'标题'</span>,max_length=<span class="number">200</span>)</span><br><span class="line">	slug = models.CharField(<span class="string">'slug'</span>,max_length=<span class="number">255</span>,blank=<span class="literal">True</span>)</span><br><span class="line">	summary = models.TextField(<span class="string">'摘要'</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    body = models.TextField(<span class="string">'正文'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> reverse(<span class="string">'post_view'</span>,args=[self.slug])</span><br></pre></td></tr></table></figure>
<p>视图views.py中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    obj = MyModel.objects.get(...)</span><br><span class="line">    <span class="keyword">return</span> redirect(obj)</span><br></pre></td></tr></table></figure>
<p>扩展：在模板中使用get_absolute_url()方法，在模板中生成标签时，使用这个方法而不用指明url路由的信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; object.get_absolute_url &#125;&#125;"</span>&gt;</span>&#123;&#123; object.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="正向解析-反向解析">正向解析，反向解析</h3>
<p>正向解析就是根据url地址访问页面</p>
<p>反向解析就是根据命名空间定向到url</p>
<p>根路由Project/urls.py里面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'app/'</span>, include(<span class="string">"app.urls"</span>), namespace=<span class="string">'app'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>应用路由app/urls.py里面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^index/'</span>, views.my_view, name=<span class="string">'index'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在模板里面使用反向解析：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--反向解析到应用app的index路由中--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url "</span><span class="attr">app:index</span>" %&#125;"&gt;</span></span><br></pre></td></tr></table></figure>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/07/17/AntConcept/">爬虫基本概念</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-07-17</span>
                
            </div>
            <div class="post-content">
                
                    <h1 id="状态码">状态码</h1>
<h2 id="2">2*</h2>
<ul>
<li>200    ok  请求成功，一般用于GET，POST请求</li>
<li>201    created    已创建</li>
<li>202    accepted    已接受</li>
<li>203    非授权信息。请求成功，但是meta信息不再原始服务器</li>
</ul>
<h2 id="3">3*</h2>
<ul>
<li>301    Moved Permanently    永久移动</li>
<li>302    Found    临时移动</li>
<li>303    SeeOther    查看其他地址，和301类似，GET重定向</li>
<li>304    NotModified    未修改，使用缓存</li>
</ul>
<h2 id="4">4*</h2>
<ul>
<li>400    BadRequest    客户端错误，请求无法理解</li>
<li>401    Unanthorized    未授权，要求身份认证</li>
<li>403    Forbidden    服务器理解客户端请求，但是拒绝执行此请求</li>
<li>404    NotFound    服务器无法根据客户端的请求找到资源</li>
<li>405    Method Not Allowed    请求方法被拒绝</li>
</ul>
<h2 id="5">5*</h2>
<ul>
<li>500    Not Implemented    服务器内部错误无法完成请求</li>
<li>502    Bad Gateway    网关错误</li>
<li>503    Service Unavailable    服务器不可用</li>
<li>504    Gateway Timeout    服务器超时</li>
</ul>
                    <div class="read-more">
                        <a href="/2019/07/17/AntConcept/" class="read-more-link">
                            阅读全文
                            <i class="iconfont icon-readmore"></i>
                        </a>
                    </div>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/07/17/AntScrapy/">scrapy基础</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-07-17</span>
                
            </div>
            <div class="post-content">
                
                    <h1 id="scrapy">Scrapy</h1>
<h2 id="getting-start">Getting start</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a new project named tutorial</span></span><br><span class="line">scrapy startproject tutorial</span><br><span class="line"><span class="comment"># get in the root direction of your project</span></span><br><span class="line"><span class="built_in">cd</span> tutorial</span><br><span class="line"><span class="comment"># create a custom spider</span></span><br><span class="line">scrapy genspider quotes quotes.toscrape.com</span><br><span class="line"><span class="comment"># scrapy genspider custom spider-name target domain</span></span><br></pre></td></tr></table></figure>
                    <div class="read-more">
                        <a href="/2019/07/17/AntScrapy/" class="read-more-link">
                            阅读全文
                            <i class="iconfont icon-readmore"></i>
                        </a>
                    </div>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/07/17/AntXpathBS/">爬虫中的xpath和beautifulsoup</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-07-17</span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="download-pic">Download Pic</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> download all the picture from xiachufang</span></span><br><span class="line">curl https://xiachufang.com/|grep -oE 'https?://.+?\.(jpg,png)' xiachufang.html| cut -d '?' -f1|cut -d "@" -f1|xargs -i curl -O &#123;&#125;`</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> curl 大写`-O`表示自动命名</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在命令行里面写python代码</span></span><br><span class="line"></span><br><span class="line">|python -c "python_code"</span><br></pre></td></tr></table></figure>
                    <div class="read-more">
                        <a href="/2019/07/17/AntXpathBS/" class="read-more-link">
                            阅读全文
                            <i class="iconfont icon-readmore"></i>
                        </a>
                    </div>
                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/07/17/hello-world/">Hello World</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-07-17</span>
                
            </div>
            <div class="post-content">
                
                    <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="create-a-new-post">Create a new post</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="run-server">Run server</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="generate-static-files">Generate static files</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="deploy-to-remote-sites">Deploy to remote sites</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/06/15/Flask组成/">Flask组成</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-06-15</span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="flask四大内置对象">Flask四大内置对象</h2>
<ol>
<li>request</li>
<li>session</li>
<li>g</li>
<li>config或app
<ul>
<li>就是当前运行的项目</li>
<li>获取当前运行的app的配置</li>
</ul>
</li>
</ol>
<h2 id="基本组成">基本组成</h2>
<ol>
<li>config配置项
<ol>
<li>注册app</li>
<li>配置数据库</li>
<li>SECRET_KEY</li>
</ol>
</li>
<li>模型
<ol>
<li>定义一个模型的类</li>
<li>可以将对需要模型完成的功能封装</li>
<li>需要初始化</li>
</ol>
</li>
<li>定义路由（接口）
<ol>
<li>使用装饰器</li>
<li>函数（FBV模型）</li>
</ol>
</li>
<li>配置run
<ol>
<li>debug</li>
<li>host</li>
<li>port</li>
</ol>
</li>
<li>static
<ol>
<li>可以直接访问</li>
</ol>
</li>
<li>templates
<ol>
<li>模板，html文件，用来渲染返回</li>
</ol>
</li>
</ol>
<h2 id="config配置项">config配置项</h2>
<h3 id="app">app</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="comment"># 注册app</span></span><br><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>
<h3 id="数据库">数据库</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="comment"># SQLALCHEMY_DATABASE_URI顺序为“数据库+数据库驱动://用户名:密码@host:port/数据库名字”</span></span><br><span class="line">app.config[<span class="string">"SQLALCHEMY_DATABASE_URI"</span>] = <span class="string">"mysql+pymysql://root:000000@localhost:3306/DatabaseName"</span></span><br><span class="line"><span class="comment"># 数据库的修改确认，定为False，否则会提示错误</span></span><br><span class="line">app.config[<span class="string">"SQLALCHEMY_TRACK_MODIFICATIONS"</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 创建数据库对象，来实现数据库的操作</span></span><br><span class="line">db = SQLAlchemy(app)</span><br></pre></td></tr></table></figure>
<h3 id="secret-key">SECRET_KEY</h3>
<p>可以设置一个SECRET_KEY来加密数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">"SECRET_KEY"</span>] = <span class="string">"123"</span></span><br></pre></td></tr></table></figure>
<h3 id="sqlalchemy">SQLAlchemy</h3>
<p>引入SQLAlchemy作为ORM，相当于翻译器，将python代码转化为数据库操作，需要对他进行配置</p>
<p>首先是引入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db = SQLAlchemy(app)</span><br></pre></td></tr></table></figure>
<p>然后是配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///hello.sqlite"</span></span><br><span class="line">app.config[<span class="string">"SQLALCHEMY_DATABASE_URI"</span>] = <span class="string">"mysql+pymysql://root:000000@localhost:3306/FlaskModel"</span></span><br><span class="line"><span class="comment"># 没有这一项配置会有警告提示</span></span><br><span class="line">app.config[<span class="string">"SQLALCHEMY_TRACK_MODIFICATIONS"</span>] = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h3 id="跨域请求">跨域请求</h3>
<p>使用flask-cors模块来解决跨域请求问题</p>
<p>安装：<code>pip install flask-cors</code></p>
<p>在__init__.py中配置跨域</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line">CORS(app)</span><br></pre></td></tr></table></figure>
<h3 id="flask中的csrf">flask中的csrf</h3>
<p>flask默认csrf关闭，可以在config.py中将其打开</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CSRF_ENABLED = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h2 id="模型">模型</h2>
<h3 id="定义一个模型的类">定义一个模型的类</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 主键自增属性</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">32</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    price = db.Column(db.Float, default=<span class="number">100</span>)</span><br><span class="line">    <span class="comment"># 外键也要定义数据类型，外键链接的是具体的字段</span></span><br><span class="line">    type = db.Column(db.Integer, db.ForeignKey(Type.id))</span><br></pre></td></tr></table></figure>
<h3 id="封装方法">封装方法</h3>
<p>一般将重复调用或者属于某个模型的方法封装在模型中，层级更加分明，使用更方便，简化代码</p>
<h3 id="flask数据库操作">Flask数据库操作</h3>
<p>创建映射表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.create_all()</span><br></pre></td></tr></table></figure>
<p>删除表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.drop_all()</span><br></pre></td></tr></table></figure>
<p>在模型类中封装save方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用SQLAlchemy作为ORM</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self)</span>:</span></span><br><span class="line">    db.session.add(self)</span><br><span class="line">    <span class="comment"># 默认是支持事务的</span></span><br><span class="line">    db.session.commit()</span><br></pre></td></tr></table></figure>
<h3 id="字段类型和约束">字段类型和约束</h3>
<ul>
<li>类型
<ul>
<li>Integer</li>
<li>Biginter</li>
<li>String</li>
<li>Text</li>
<li>Date</li>
<li>Time</li>
<li>Boolean</li>
</ul>
</li>
<li>约束
<ul>
<li>primary_key</li>
<li>autoincrement</li>
<li>unique</li>
<li>nullable</li>
<li>default</li>
<li>index</li>
<li>ForeignKey</li>
</ul>
</li>
</ul>
<h3 id="数据库的迁移">数据库的迁移</h3>
<p>迁移是指将模型转变成数据库中的表，使用flask-migrate模块，可以结合flask-script使用，script模块可以给项目定制脚本，设定运行参数，代替在run里面的设置</p>
<p>首先安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-migrate</span><br><span class="line"><span class="meta">#</span><span class="bash"> 结合flask-script使用</span></span><br><span class="line">pip install flask-script</span><br></pre></td></tr></table></figure>
<p>配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绑定app和db</span></span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"><span class="comment"># 给app添加迁移命令</span></span><br><span class="line">manager = Manager(app)</span><br><span class="line">manager.add_command(<span class="string">"db"</span>, MigrateCommand)</span><br></pre></td></tr></table></figure>
<p>使用命令迁移数据库模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pythom manager.py db init  <span class="comment"># 初始化</span></span><br><span class="line">python manager.py db migrate -m <span class="string">'Version'</span>  <span class="comment"># 生成迁移文件，-m 制定版本信息</span></span><br><span class="line">python manager.py db upgrade  <span class="comment"># 迁移</span></span><br><span class="line">python manager.py db downgrade  <span class="comment"># 降级</span></span><br></pre></td></tr></table></figure>
<h2 id="路由-接口">路由（接口）</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 路由的地址为login，支持GET，POST方法</span></span><br><span class="line"><span class="meta">@app.route('/login/', methods=["GET", "POST"])</span></span><br><span class="line"><span class="comment"># 接口方法名为login</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br></pre></td></tr></table></figure>
<p><strong>Flask中的request是全局可用的，不需要传入路由</strong></p>
<h3 id="路由操作数据库">路由操作数据库</h3>
<p>查询方法：</p>
<ul>
<li>get</li>
<li>filter</li>
<li>order_by
<ul>
<li>必须先调用</li>
</ul>
</li>
<li>limit</li>
<li>offset
<ul>
<li>offset和limit先执行offset</li>
</ul>
</li>
<li>paginate</li>
<li>条件
<ul>
<li>&gt;    __gt_ _</li>
<li>&lt;    <em>_lt</em>_</li>
<li>==</li>
<li>&gt;=</li>
<li>&lt;=</li>
<li>in_</li>
<li>like</li>
<li>startswith----前面加i忽略大小写</li>
<li>endswith</li>
</ul>
</li>
</ul>
<p>操作命令例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取Student数据并分页显示，默认10条一页</span></span><br><span class="line">pagination = Student.query.paginate()</span><br></pre></td></tr></table></figure>
<p><strong>使用文本化SQL</strong></p>
<p>使用 <code>text()</code> 方法可以用文本化的方式执行查询，使得语法更灵活，<code>filter()</code>和<code>order_by()</code>都可以使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span><br><span class="line"><span class="comment"># 在view视图中调用</span></span><br><span class="line">filter(text(<span class="string">"id&lt;3"</span>))</span><br></pre></td></tr></table></figure>
<p>保存：<code>object.save()</code></p>
<h3 id="方法">方法</h3>
<h4 id="模板渲染">模板渲染</h4>
<p>render_template()：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.router('index')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">'xxx.html'</span>, pagination=pagination, msg=<span class="string">'hahahaha'</span>)</span><br></pre></td></tr></table></figure>
<p>重定向redirect()：</p>
<p>结合反向解析url_for()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># login是定义的路由接口</span></span><br><span class="line"><span class="keyword">return</span> rerdirect(url_for(<span class="string">"login"</span>))</span><br></pre></td></tr></table></figure>
<h4 id="设置cookie">设置cookie</h4>
<p>定义一个Response用做返回，用Response调用set_cookie()方法，代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response = redirect(url_for(<span class="string">'mine'</span>))  <span class="comment"># 重定向</span></span><br><span class="line">response.set_cookie(<span class="string">"key"</span>, value)</span><br><span class="line"><span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h4 id="设置session">设置session</h4>
<p>导入flask中的session，通过键值对方法设置session，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session[<span class="string">"u_name"</span>] = user.name</span><br><span class="line">session[<span class="string">"u_icon"</span>] = user.icon</span><br></pre></td></tr></table></figure>
<h4 id="从提交的数据中获取文件">从提交的数据中获取文件</h4>
<ul>
<li>view试图获取文件</li>
</ul>
<p>获取用户上传的文件，存储在服务器，然后在数据库中存储路径</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">icon = request.files.get(<span class="string">"icon"</span>)</span><br><span class="line"><span class="comment"># 设置路径并存储头像</span></span><br><span class="line">ext = <span class="string">"."</span> + icon.filename.split(<span class="string">"."</span>)[<span class="number">-1</span>]</span><br><span class="line">save_path = <span class="string">"PATH"</span> + u_name + ext</span><br><span class="line">icon.save(save_path)</span><br></pre></td></tr></table></figure>
<ul>
<li>模板中上传</li>
</ul>
<p>在input中需要定义一个属性，向浏览器声明文件传输的操作</p>
<p>示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">&#123;&#123;</span> <span class="attr">url_for</span>("<span class="attr">user_blue.register</span>") &#125;&#125; <span class="attr">entype</span>=<span class="string">"mulitipart/form-data"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="token">token</h4>
<p>首先要安装flask-caching模块，设置radis作为缓存数据库，在第三方库里面配置。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_caching <span class="keyword">import</span> Cache</span><br><span class="line">cache = Cache(config=&#123;</span><br><span class="line">    <span class="string">"CACHE_TYPE"</span>: <span class="string">"redis"</span>,</span><br><span class="line">    <span class="string">"CACHE_REDIS_URL"</span>: <span class="string">"redis://:PASSWORD@localhost:6370/1"</span></span><br><span class="line">&#125;)</span><br><span class="line">TOKEN_TIME_OUT = <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span></span><br><span class="line"><span class="comment"># 在init_ext(app)中注册</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_ext</span><span class="params">(app)</span>:</span></span><br><span class="line">    cache.init_app(app)</span><br></pre></td></tr></table></figure>
<p>在view试图中使用token，设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">token = uuid.uuid4().hex</span><br><span class="line">cache.set(token, user.id, timeout=TOKEN_TIME_OUT)</span><br></pre></td></tr></table></figure>
<p>获取：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cache.get(<span class="string">"token"</span>)</span><br></pre></td></tr></table></figure>
<p>使用flask-httpauth来进行flask的auth认证，查看博客：</p>
<p><a href="https://segmentfault.com/a/1190000011277435" target="_blank" rel="noopener">https://segmentfault.com/a/1190000011277435</a></p>
<h4 id="g对象">g对象</h4>
<p>g对象是一个可以全局（应用内）传递参数的对象，将需要携带的数据，作为自己本身的属性进行传递，生命周期只有一个request的长度。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> g</span><br><span class="line">g.msg = <span class="string">"balabala"</span></span><br></pre></td></tr></table></figure>
<p>在html中接受g</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; g.msg &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="blueprint">Blueprint</h2>
<p>将项目按照整体配置和具体业务进行拆分的写法，实现高内聚、低耦合，便于管理。</p>
<h3 id="项目目录">项目目录</h3>
<h4 id="init-初始化模块">__init__初始化模块</h4>
<ul>
<li>创建Flask对象<code>app = Flask(__name__, template_folder='../templates')</code></li>
<li>初始化配置<code>app.config.from_object(envs.get(env))</code></li>
<li>初始化扩展库<code>init_ext(app)</code></li>
<li>加载中间件<code>load_middleware(app)</code></li>
<li>加载路由<code>init_blue(app)</code></li>
<li><code>return app</code></li>
</ul>
<h4 id="config或setting系统设置模块">config或setting系统设置模块</h4>
<ul>
<li>配置环境，直接定义成类，选择环境时获取属性即可</li>
<li>配置数据库，根据环境选择不同的数据库</li>
<li>配置其他项（KEY, DEBUG, TESTING, SQLALCHEMY_TRACK_MODIFICATIONS）</li>
</ul>
<h4 id="views试图函数模块">views试图函数模块</h4>
<ul>
<li>将子试图里面的路由集初始化</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_blue</span><span class="params">(app)</span>:</span></span><br><span class="line">    app.register_blueprint(blueprint=user_blue)</span><br><span class="line">    app.register_blueprint(blueprint=movie_blue)</span><br></pre></td></tr></table></figure>
<h4 id="extension第三方库模块">extension第三方库模块</h4>
<ul>
<li>
<p>配置ORM</p>
</li>
<li>
<p>配置缓存</p>
</li>
<li>
<p>migrate迁移命令</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db = SQLAlchemy()</span><br><span class="line">migrate = Migrate()</span><br><span class="line">cache = Cache(config=&#123;</span><br><span class="line">    <span class="string">"CACHE_TYPE"</span>: <span class="string">"redis"</span>,</span><br><span class="line">    <span class="string">"CACHE_REDIS_URL"</span>: <span class="string">"redis://:000000@127.0.0.1:6379/1"</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_ext</span><span class="params">(app)</span>:</span></span><br><span class="line">    db.init_app(app)</span><br><span class="line">    migrate.init_app(app)</span><br><span class="line">    cache.init_app(app)</span><br></pre></td></tr></table></figure>
<h4 id="middleware中间件">middleware中间件</h4>
<p>首先引入一个概念，面向切面编程，在Flask中的中间件是用装饰器来实现的，可以在不修改源代码的情况下，对既有程序添加功能</p>
<ul>
<li>请求接受前
<ul>
<li>befor_request接受request数据</li>
</ul>
</li>
<li>请求接收后
<ul>
<li>after_request接受request和response数据</li>
</ul>
</li>
<li>捕获异常
<ul>
<li>errorhandler接受request和exception数据</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_middleware</span><span class="params">(app)</span>:</span></span><br><span class="line"><span class="meta">    @app.before_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">app_before</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="meta">    @app.after_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">after</span><span class="params">(resp)</span>:</span></span><br><span class="line">        print(resp)</span><br><span class="line"><span class="meta">    @errorhandler(500)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">error500</span><span class="params">(exce)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"跳转到首页"</span></span><br></pre></td></tr></table></figure>
<h3 id="app目录结构">App目录结构</h3>
<h4 id="models模型模块">models模型模块</h4>
<ul>
<li>定义抽象基类继承自<code>(db.Model)</code>，其他模板直接继承自它，然后设置属性<code>__abstract__ = True</code>使其不再数据库中生成映射。可选</li>
<li>模型定义的属性就是数据表的字段，设置约束就是数据表的约束</li>
<li>封装方法</li>
</ul>
<h4 id="views视图模块">views视图模块</h4>
<p>首先定义路由集，其他的路由函数都用这个视图集装饰，在根路由中注册路由集后就可以直接按照url访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url_prefix是路由前缀，url访问的地址</span></span><br><span class="line">user_blue = Blueprint(<span class="string">"user_blue"</span>, __name__, url_prefix=<span class="string">"/user"</span>)</span><br></pre></td></tr></table></figure>
<p>定义路由时，用其进行装饰：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@user_blue.router("/idnex/", method=["GET", "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello World"</span></span><br></pre></td></tr></table></figure>
<h2 id="flask-restful">flask-RESTful</h2>
<p>flask-RESTful是flask的API写法，和Django中的Django-REST-framework类似，属于CBV模型，通过函数试图模型来实现接口功能，实现继承和方法的封装重写，python里的类继承是写的最好的，API式的开发方式，充分发挥了这个优点。</p>
<p>flask-RESTful也是flask的一种，模块拆分和配置和flask大致相同，<a href="http://xn--settings-8t1ms5qqzau60e0y9ae6b665no0xccp3a.py" target="_blank" rel="noopener">首先是写好配置文件settings.py</a>, <a href="http://ext.py" target="_blank" rel="noopener">ext.py</a>, <a href="http://xn--views-7b4k.py" target="_blank" rel="noopener">根views.py</a>，跟前文的配置类似。区别在于，因为是API式的写法，在views.py中注册路由，是注册的router.py中定义的Api，例如：</p>
<p>在app/views.py中定义资源类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppResource</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="comment"># 重写post方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"status"</span>: <span class="number">201</span>,</span><br><span class="line">            <span class="string">"msg"</span>: <span class="string">"add ok"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p>在app/router.py中定义Api路由：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Api</span><br><span class="line"><span class="comment"># prefix前缀，这个api的的根</span></span><br><span class="line">app_api = Api(prefix=<span class="string">'/app'</span>)</span><br><span class="line"><span class="comment"># AppResource是在views中定义的资源类</span></span><br><span class="line">app_api.add_resource(AppResource, <span class="string">'/'</span>)</span><br></pre></td></tr></table></figure>
<p>在Project/views.py中注册：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_app</span><span class="params">(app)</span>:</span></span><br><span class="line">    <span class="comment"># 在flask中需要用init_app()来初始化路由</span></span><br><span class="line">    app_api.init_app(app)</span><br></pre></td></tr></table></figure>
<p>在app的router.py中注册的路由，加上一个<code>prefix='/app'</code>的参数，就是url的路径前缀，例如 <a href="http://127.0.0.1:5000/app/" target="_blank" rel="noopener">http://127.0.0.1:5000/app/</a> ，在资源类中同意接受通过这个url传入的请求，通过继承和重写，实现定制功能。</p>
<h3 id="models">models</h3>
<p>引入一个flask中的密码校验机制，generate_password_hash和ckeck_password_hash方法。输入密码每次输出的密文都不同，同时可以通过check_password_hash方法来验证密码。</p>
<p>实现原理大致为，先对密码进行hash加密，再将加密后的hash字符串拼接一个定制的字符串，验证是去除定制的字符串，然后将接收的密码hash，比较两个hash。</p>
<p>models的定义方式就是flask中定义模型的方式</p>
<h3 id="router">router</h3>
<p>用来定义api路由，并用add_resource()方法添加到views.py中的资源类中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blogs_api = Api(prefix=<span class="string">"/blogs"</span>)</span><br><span class="line">blogs_api.add_resource(BlogsResource, <span class="string">"/"</span>)</span><br><span class="line">blogs_api.add_resource(BlogResource, <span class="string">"/&lt;int:pk&gt;/"</span>)  <span class="comment"># 传入参数时，经过这个路由</span></span><br></pre></td></tr></table></figure>
<h3 id="views">views</h3>
<h4 id="定义资源类">定义资源类</h4>
<p>在views.py中定义一个资源类，继承自Resource，Resource重写了父类MethodView中的<code>dispatch_request</code>方法，获取并校验请求方法名，并根据方法名分发请求。</p>
<p>资源类中重写方法名函数，实现功能的定制。</p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersResource</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="comment"># 重写post请求的处理方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        args = parse.parse_args()</span><br><span class="line">        action = args.get(<span class="string">"action"</span>)</span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">"register"</span>:</span><br><span class="line">            <span class="keyword">return</span> self.do_register()</span><br></pre></td></tr></table></figure>
<p>在view中根据需要传入的参数，添加请求参数规则</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource, reqparse</span><br><span class="line"><span class="comment"># 首先声明请求转换器</span></span><br><span class="line">parse = reqparse.RequestParser()</span><br><span class="line"><span class="comment"># 添加请求参数规则</span></span><br><span class="line">parse.add_argument(<span class="string">"username"</span>, required=<span class="literal">True</span>, type=str, help=<span class="string">"username can`t be blank"</span>)</span><br></pre></td></tr></table></figure>
<p>添加转换器后获取参数，从转换器中获取区别于之前的request获取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接获取</span></span><br><span class="line">username = request.form.get(<span class="string">"username"</span>)</span><br><span class="line"><span class="comment"># 通过过滤规则</span></span><br><span class="line">args = parse.parse_args()</span><br><span class="line"><span class="comment"># 获取html中form表单的数据，如果客户端不是html也能提交表单数据</span></span><br><span class="line">action = args.get(<span class="string">"action"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="格式化数据">格式化数据</h4>
<p>格式化数据是<strong>flask_restful</strong>里面的一个写法，定义一个fields字典格式的格式化模板，对获取和输出的数据进行格式化操作，省去了手动改变格式的麻烦。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个格式化数据的模板</span></span><br><span class="line">data_fields = &#123;</span><br><span class="line">    <span class="string">"id"</span>: fields.Integer(attribute=<span class="string">"number"</span>),</span><br><span class="line">    <span class="string">"name"</span>: fields.String(default=<span class="string">"Tom"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 定义一个要返回的信息模板</span></span><br><span class="line">return_fields = &#123;</span><br><span class="line">    <span class="string">"status"</span>: fields.Integer,</span><br><span class="line">    <span class="string">"msg"</span>: fields.String,</span><br><span class="line">    <span class="comment"># 级联数据写法</span></span><br><span class="line">    <span class="string">"data"</span>: fields.Nested(student)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出格式化的数据可以使用两种方法：</p>
<ol>
<li>装饰器</li>
</ol>
<p>在请求方法函数前面加上<code>@marshal_with(return_fields)</code>，输出的数据会自动根据return_fields格式化</p>
<ol start="2">
<li>调用marshal方法</li>
</ol>
<p>在return的data中用marhsal方法来格式化数据，同样需要传入一个模板</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">201</span>,</span><br><span class="line">    <span class="string">"data"</span>: marshal(data, data_fields)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line"><span class="comment"># 或这直接输出</span></span><br><span class="line"><span class="comment"># return marshal(data, data_fields)</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>输出字典格式数据</li>
</ol>
<p>如果元数据不是字典格式，就需要将其写成字典格式，重复使用体验不佳，视情况而定。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="number">201</span>,</span><br><span class="line">    <span class="comment"># to_dick是已经封装好的方法</span></span><br><span class="line">    <span class="string">"data"</span>: [book.to_dict() <span class="keyword">for</span> bood <span class="keyword">in</span> books]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用装饰器给请求的处理方法添加方法和属性。定义一个方法，实现对传入请求处理方法的参数进行处理。</p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ 定义装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_required</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        token = request.form.get(<span class="string">"token"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="keyword">raise</span> <span class="string">"error"</span></span><br><span class="line">        user_id = cache.get(token)</span><br><span class="line">        user = User.query.get(user_id)</span><br><span class="line">        g.user = user</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>
<p>在资源类中装饰请求方法函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogResource</span><span class="params">(Resource)</span>:</span></span><br><span class="line"><span class="meta">    @login_required</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ok"</span></span><br></pre></td></tr></table></figure>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/06/10/在VScode上用代码撸UML图/">在VScode上用代码撸UML图</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-06-10</span>
                
            </div>
            <div class="post-content">
                
                    <p>[TOC]</p>
<h1 id="uml图">UML图</h1>
<h2 id="uml和plantuml">UML和PlantUML</h2>
<p>UML-Unified Modeling Language 统一建模语言，又称标准建模语言。是用来对软件密集系统进行可视化建模的一种语言。UML的定义包括UML语义和UML表示法两个元素。</p>
<p>PlantUML是一个实现UML快速绘图的开源项目，你可以在他的官网 <a href="http://plantuml.com/zh/" target="_blank" rel="noopener">http://plantuml.com/zh/</a> 找到下载包，是一个Java的jar包，但是你首先需要安装Java环境。</p>
<p>本文主要讲在VScode上利用PlantUML插件和Markdown Preview Enhance插件实现快速绘图，并导出图像。前者支持<code>*.wsd, *.pu, *.puml, *.plantuml, *.iuml</code>格式的文件，后者支持在Markdown中直接绘图和预览，并通过其他插件将Markdown文件导出为其他格式。</p>
<h2 id="vscode">VScode</h2>
<p>VScode是微软的针对于编写现代 Web 和云应用的跨平台源代码编辑器，同样支持多种文档的编写，插件丰富，功能强大，尤其是对于前端开发，相当友好，同样也可以用来开发Python项目。</p>
<p>VScode官网：<a href="https://code.visualstudio.com/" target="_blank" rel="noopener">https://code.visualstudio.com/</a> ，你可以直接下载对应系统的安装包，安装使用，不需要其他配置。新版的VScode将软件设置，从JSON格式改为了图形界面，不过同样可以编辑设置的JSON文件，如果你需要旧版JSON格式的设置界面，请自行搜索下载。</p>
<h2 id="java">Java</h2>
<h3 id="下载">下载</h3>
<p>你可以在ORACLE的Java官方站点下载对应系统的Java安装包，最新版的是Java SE12.0.1，推荐安装Java SE 8u211版本，在JDK那一项，点击Downloade。你需要下载的是 <strong>Java SE Development Kit 8u211</strong>，然后点击<strong>Accept License Agreement</strong>前面的按钮，X86代表32位的操作系统，X64代表64位的操作系统，选择对应的包下载即可。</p>
<h3 id="安装和环境变量">安装和环境变量</h3>
<h4 id="安装">安装</h4>
<p>下载完成后点击安装。</p>
<p>Windows可视情况安装在C盘或其他位置。Ubuntu用户可以直接下载deb安装包直接安装，找到你的Java安装位置，添加环境变量，或者下载压缩包自定义Java的位置。MacOS用户请自行百度。</p>
<h4 id="环境变量">环境变量</h4>
<h5 id="windows10">Windows10</h5>
<p>在搜索中搜索<strong>高级系统设置</strong>，点击进入<br>
[外链图片转存失败(img-E2IAh1dQ-1563347765263)(<a href="https://github.com/belingud/image/blob/master/csdnblog/%E9%AB%98%E7%BA%A7%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/高级系统设置.png?raw=true</a>)]<br>
找到<strong>环境变量</strong>，点击进入：<br>
[外链图片转存失败(img-rLnXqfqh-1563347765264)(<a href="https://github.com/belingud/image/blob/master/csdnblog/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/环境变量.png?raw=true</a>)]<br>
点击系统变量下面的新建，创建一个<strong>JAVE_HOME</strong>的系统变量，值为你Java安装的目录，自行变动，比如：</p>
<blockquote>
<p>D:\Program Files\Java\jdk1.8.0_91</p>
</blockquote>
<p>[外链图片转存失败(img-Pi63wW57-1563347765266)(<a href="https://github.com/belingud/image/blob/master/csdnblog/%E6%B7%BB%E5%8A%A0JAVA_HOME.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/添加JAVA_HOME.png?raw=true</a>)]<br>
然后设置<strong>CLASS_PATH</strong>，值为<code>.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;</code>，复制粘贴即可：</p>
<p>[外链图片转存失败(img-rnrsDin3-1563347765271)(<a href="https://github.com/belingud/image/blob/master/csdnblog/java_class_path.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/java_class_path.png?raw=true</a>)]<br>
然后找到<strong>系统变量</strong>中的<strong>Path</strong>，双击进入，点击新建，添加下面两行：</p>
<blockquote>
<p>变量值：%JAVA_HOME%\bin<br>
变量值：%JAVA_HOME%\jre\bin</p>
</blockquote>
<p>如图：<br>
[外链图片转存失败(img-c6W3owHo-1563347765273)(<a href="https://github.com/belingud/image/blob/master/csdnblog/java.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/java.png?raw=true</a>)]<br>
测试：</p>
<p>在CMD或者Powershell中输入<code>javac</code>或者<code>java -version</code>检查是否安装成功。提示错误请重新检查安装步骤。</p>
<h5 id="ubuntu">Ubuntu</h5>
<p>同样在官网下载对应的安装包，安装后可以选择设置全局变量还是用户变量。</p>
<ol>
<li>修改全局变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure>
<p>在profile末尾增加<code>JAVA_HOME</code>、<code>CLASSPATH</code>和<code>PATH</code>，例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java/jdk1.8.0_171  # java的安装或解压目录</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib/dt.jar:$&#123;JAVA_HOME&#125;/lib/tools.jar</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>然后运行<code>source /etc/profile</code>，是环境立即生效。</p>
<ol start="2">
<li>修改用户变量</li>
</ol>
<p>修改当前用户配置文件.bashrc，只作用于当前用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>设置与上一样</p>
<p>然后运行<code>source ~/.bashrc</code>，设设置立即生效。</p>
<p><strong>测试：</strong></p>
<p>运行<code>java -version</code>，查看java版本，如果正常输出版本信息则配置正确，你可以重启使设置永久生效。</p>
<h5 id="mac">Mac</h5>
<p>按照上面的步骤下载Java，下载完成后打开dmp，可以找到Java的根目录，如图。<br>
[外链图片转存失败(img-xj1qRvm0-1563347765276)(<a href="https://github.com/belingud/image/blob/master/csdnblog/MacJava.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/MacJava.png?raw=true</a>)]<br>
编辑系统变量，添加JAVA_HOME、CLASS_PATH、PATH，打开终端，输入命令<code>sudo vim /etc/profile</code>进行编辑</p>
<blockquote>
<p>在终端输入 /usr/libexec/java_home 可以查看java的安装目录</p>
</blockquote>
<p>添加下面几行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME="/Library/Java/JavaVirtualMachines/jdk1.8.0_131.jdk/Contents/Home"</span><br><span class="line">export JAVA_HOME</span><br><span class="line">CLASS_PATH="$JAVA_HOME/lib"</span><br><span class="line">PATH=".$PATH:$JAVA_HOME/bin"</span><br></pre></td></tr></table></figure>
<p>保存并退出，运行<code>source /etc/profile</code>使配置立即生效。<br>
终端输入<code>java -version</code>检查配置是否生效。</p>
<h2 id="vscode配置">VScode配置</h2>
<p>VScode和Java安装成功之后，就可以配置VScode使其支持UML绘图。</p>
<h3 id="plantuml">PlantUML</h3>
<h4 id="安装-v2">安装</h4>
<p>安装PlantUML开源插件，支持多种文件后缀的UML图。</p>
<p>找到VScode扩展页，或者按<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>X</kbd>快捷键，直接打开。在搜索栏中搜索<strong>PlantUML</strong>，点击安装。生成其他的图形你可能需要安装GrapgViz(非必需)，不过一般情况下PlantUML足矣。</p>
<p>在扩展的介绍页面，有详细的配置讲解和注意事项，这里只进行简单的讲解。</p>
<h4 id="设置">设置</h4>
<p>点击VScode左下角的设置，然后点击设置右上角花括号，如图：</p>
<p>[外链图片转存失败(img-LV8JIAZq-1563347765280)(<a href="https://github.com/belingud/image/blob/master/csdnblog/VScode%E8%AE%BE%E7%BD%AE.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/VScode设置.png?raw=true</a>)]</p>
<p>点击后：</p>
<p>[外链图片转存失败(img-M0fZIP8j-1563347765283)(<a href="https://github.com/belingud/image/blob/master/csdnblog/VScodeJSON.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/VScodeJSON.png?raw=true</a>)]</p>
<p>添加下面一行：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"plantuml.includepaths": ["docs/diagrams/style","docs/diagrams/src"],</span><br></pre></td></tr></table></figure>
<p>你也可以设置导出和引用的目录，官方的提示是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"plantuml.diagramsRoot": "docs/diagrams/src",</span><br><span class="line">"plantuml.exportOutDir": "docs/diagrams/out"</span><br></pre></td></tr></table></figure>
<p>相对目录，可以自己设置（不建议）</p>
<p>基本的设置就是这些，其他的提示可以到插件详情里面查看。设置到这里，你就可以愉快的撸流程图了。</p>
<h4 id="使用">使用</h4>
<p>UML的语法可以在<a href="http://plantuml.com/zh/" target="_blank" rel="noopener">PlantUML</a>或者网页搜索UML语法查看。这里不再赘述。在VScode中创建新文件，后缀改为<code>*.wsd, *.pu, *.puml, *.plantuml, *.iuml</code>，输入代码。</p>
<p>PlantUML语法，以<code>@startuml</code>开头，以<code>@enduml</code>结束，中间键入图表代码。</p>
<ol>
<li>右键点击文件区域，可以看到下面的列表，可以点击预览，导出等</li>
</ol>
<p>[外链图片转存失败(img-3rl9Anum-1563347765287)(<a href="https://github.com/belingud/image/blob/master/csdnblog/%E5%8F%B3%E9%94%AE%E7%82%B9%E5%87%BB.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/右键点击.png?raw=true</a>)]</p>
<ol start="2">
<li>或者使用快捷键<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>P</kbd>，打开命令面板，搜索PlantUML，有相同的选项列表，不再贴图。</li>
</ol>
<h3 id="markdown-preview-enhanced">Markdown Preview Enhanced</h3>
<p>不只是使用PlantUML插件，你同样可以在Markdown文件中画UML图，通过<strong>Markdown Preview Enhanced</strong>插件来预览和导出，同样依赖与Java。</p>
<h4 id="安装-v3">安装</h4>
<p>找到VScode扩展页，或者按<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>X</kbd>快捷键，直接打开。在搜索栏中搜索<strong>Markdown Preview Enhanced</strong>，点击安装。</p>
<blockquote>
<p>对于书写Markdown文件，你可能需要一个叫做<strong>Markdown All In One</strong>的插件，可以自动补充markdown语法，并支持快捷键。</p>
</blockquote>
<p>这个插件不需要其他的设置，你可以直接使用其进行预览。在Markdown编辑页面的右上角，找到<code>Open Preview To The Side</code>，点击，或者在空白处点击右键，在列表里面找到<code>Open Preview To The Side</code>，就可以在侧边预览Markdown文件的效果。</p>
<h4 id="使用-v2">使用</h4>
<p>在markdown中画uml图表，需要写在代码块中，语言标识为plantuml。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">```plantuml开头</span><br><span class="line">@srartuml</span><br><span class="line">。。。</span><br><span class="line">@enduml</span><br><span class="line">``</span><br></pre></td></tr></table></figure>
<p>在预览图中点击右键，可以看到设置菜单，<em>PDF</em>,<em>eBook</em>,<em>Pandoc</em>导出需要自行安装<em>prince xml</em>,<em>pandoc</em>插件，prince xml结合插件生成的PDF效果并不让人满意，如果有需求请自行搜索。推荐使用<strong>Chrome</strong>导出文件。</p>
<p>[外链图片转存失败(img-TI6ezCqL-1563347765290)(<a href="https://github.com/belingud/image/blob/master/csdnblog/Enhance%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95.png?raw=true" target="_blank" rel="noopener">https://github.com/belingud/image/blob/master/csdnblog/Enhance右键菜单.png?raw=true</a>)]</p>
<p><strong>注意，如果图画的太长会被分成多页。</strong></p>
<h2 id="atom配置">Atom配置</h2>
<p>Atom类似于VScode，也是一个优秀的源代码编辑工具，你也可以使用他来画UML图表，官网：<a href="https://atom.io/" target="_blank" rel="noopener">https://atom.io/</a> 同VScode一样，需要在<strong>install</strong>中搜索PlantUML或者Markdown Preview Enhanced插件安装，不需要其他设置，使用也和VScode中类似，不再赘述。</p>
<hr>
<br>
<br>
<h2 id="参考">参考</h2>
<p>Windows10设置Java环境变量：<a href="https://www.cnblogs.com/silence9527/p/7358239.html" target="_blank" rel="noopener">https://www.cnblogs.com/silence9527/p/7358239.html</a></p>
<p>Ubuntu设置Java环境变量：</p>
<p><a href="https://www.tiomg.org/blog?uuid=9a239850-e28c-4723-9f54-1442cb9480dc" target="_blank" rel="noopener">https://www.tiomg.org/blog?uuid=9a239850-e28c-4723-9f54-1442cb9480dc</a></p>
<p>PlantUML官方站点：</p>
<p><a href="http://plantuml.com/zh/" target="_blank" rel="noopener">http://plantuml.com/zh/</a></p>
<p>Markdown Preview Enhanced官方站点：</p>
<p><a href="https://shd101wyy.github.io/markdown-preview-enhanced/#/" target="_blank" rel="noopener">https://shd101wyy.github.io/markdown-preview-enhanced/#/</a></p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/2019/05/24/切换pip下载源/">切换pip下载源</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2019-05-24</span>
                
            </div>
            <div class="post-content">
                
                    <p>[TOC]</p>
<h1 id="前言">前言</h1>
<p><strong><code>pip install package-name</code>命令会直接从官方源(<a href="https://pypi.python.org/pypi" target="_blank" rel="noopener">https://pypi.python.org/pypi</a>)安装，速度感人，可以在安装包时，<code>-i</code>加pypi源地址，也可以将pip的源地址改为国内的镜像站地址，一劳永逸，速度有明显的提升</strong></p>
<h1 id="配置">配置</h1>
<h2 id="1-使用psm">1. 使用psm</h2>
<p>源码github地址： <a href="https://github.com/brandonxiang/psm" target="_blank" rel="noopener">https://github.com/brandonxiang/psm</a></p>
<p>本文使用了pyenv创建的虚拟环境，python版本为3.6.6，pip版本为19.1.1，用pyenv创建python虚拟环境的教程可以在博客 <a href="https://blog.csdn.net/qq_27114273/article/details/90340754" target="_blank" rel="noopener">https://blog.csdn.net/qq_27114273/article/details/90340754</a> 中找到，不再赘述，创建完成后用命令<code>pyenv activate env-name</code>进入虚拟环境。同样也可以使用virtualenv组合virtualenvwrapper来创建虚拟环境，指定为系统环境中的python版本。</p>
<h3 id="linux-的使用">Linux 的使用</h3>
<p>以下操作需要在Linux虚拟环境外进行，选择好镜像源后在进入虚拟环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(env366)vic@hell:~$ pip install psm</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果系统中同时装有python2和python3，想要安装到python3环境中，需要使用<code>pip3 install psm</code>来进行安装</p>
</blockquote>
<ol>
<li>列出pip的镜像源</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(env366)vic@hell:~$ psm ls</span><br></pre></td></tr></table></figure>
<p>psm支持的国内镜像如下：</p>
<ul>
<li>pypi 	 <a href="https://pypi.python.org/simple/" target="_blank" rel="noopener">https://pypi.python.org/simple/</a></li>
<li>douban 	 <a href="https://pypi.douban.com/simple/" target="_blank" rel="noopener">https://pypi.douban.com/simple/</a></li>
<li>aliyun 	 <a href="http://mirrors.aliyun.com/pypi/simple/" target="_blank" rel="noopener">http://mirrors.aliyun.com/pypi/simple/</a></li>
</ul>
<p>查看当前的镜像源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(env366) vic@hell:~$ psm show</span><br><span class="line"></span><br><span class="line">Current source is douban</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>选择指定的镜像源</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(env366) vic@hell:~$ psm use douban</span><br><span class="line"></span><br><span class="line">Source is changed to douban.</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>使用pip下载库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(env366) vic@hell:~$ pip install package-name</span><br></pre></td></tr></table></figure>
<h3 id="windows-的使用">Windows 的使用</h3>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install psm</span><br></pre></td></tr></table></figure>
<p>同样，想要安装到python3版本中，则使用<code>pip3 install psm</code>来进行安装</p>
<p>列出所有源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m psm ls</span><br></pre></td></tr></table></figure>
<p>更换pypi源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m psm use douban</span><br></pre></td></tr></table></figure>
<p>显示当前源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m psm show</span><br></pre></td></tr></table></figure>
<h2 id="2-修改配置文件">2. 修改配置文件</h2>
<ul>
<li>阿里云 <a href="http://mirrors.aliyun.com/pypi/simple/" target="_blank" rel="noopener">http://mirrors.aliyun.com/pypi/simple/</a></li>
<li>中国科技大学 <a href="https://pypi.mirrors.ustc.edu.cn/simple/" target="_blank" rel="noopener">https://pypi.mirrors.ustc.edu.cn/simple/</a></li>
<li>豆瓣 <a href="https://pypi.douban.com/simple/" target="_blank" rel="noopener">https://pypi.douban.com/simple/</a></li>
<li>清华大学 <a href="https://pypi.tuna.tsinghua.edu.cn/simple/" target="_blank" rel="noopener">https://pypi.tuna.tsinghua.edu.cn/simple/</a></li>
<li>中国科学技术大学 <a href="http://pypi.mirrors.ustc.edu.cn/simple/" target="_blank" rel="noopener">http://pypi.mirrors.ustc.edu.cn/simple/</a></li>
<li>华中理工大学 <a href="http://pypi.hustunique.com/" target="_blank" rel="noopener">http://pypi.hustunique.com/</a></li>
<li>山东理工大学 <a href="http://pypi.sdutlinux.org/" target="_blank" rel="noopener">http://pypi.sdutlinux.org/</a></li>
<li>v2ex <a href="http://pypi.v2ex.com/simple/" target="_blank" rel="noopener">http://pypi.v2ex.com/simple/</a></li>
</ul>
<p>更改配置文件，将其设为默认pip源，例如切换到清华大学开源软件镜像站，清华镜像站的pypi 镜像每 5 分钟同步一次。但是清华的TensorFlow更新的比较慢。</p>
<p>临时使用可以使用命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple package-name</span><br></pre></td></tr></table></figure>
<h3 id="linux下修改">Linux下修改</h3>
<p><em>pip的版本&gt;=10.0.0</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<p>网络较差时，使用清华镜像站来升级 pip：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pip -U</span><br></pre></td></tr></table></figure>
<p><strong>如果不想升级pip的版本，可以通过修改配置文件来切换pip镜像源</strong></p>
<p>修改～/.pip/pip.conf文件，添加以下内容，没有此文件或目录就创建一个</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">trusted-host = pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<h3 id="windows下修改">Windows下修改</h3>
<ol>
<li>在文件管理器的地址栏中输入<code>%APPDATA%</code>，会切换到用户路径下的appdata目录</li>
<li>找到目录中的pip文件夹，没有就创建新文件夹为pip，在此文件夹下创建文件pip.ini，完整路径为<code>%APPDATA%/pip/pip.ini</code></li>
<li>在pip.ini中添加以下代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout = 6000</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">trusted-host = pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<h3 id="mac下修改">Mac下修改</h3>
<ol>
<li>切换到pip路径下，路径为：</li>
</ol>
<p><code>$HOME/Library/Application Support/pip/pip.conf</code></p>
<p><code>%HOME%</code>为用户的家目录</p>
<ol start="2">
<li>如果没有上面的目录,在如下目录创建 pip.conf文件</li>
</ol>
<p><code>$HOME/.config/pip/pip.conf</code></p>
<ol start="3">
<li>添加以下代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url=https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">[install]</span><br><span class="line">trusted-host=pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<h1 id="注意">注意</h1>
<blockquote>
<p>修改配置文件添加的代码后，可能会出错，尽量使用https加密源</p>
</blockquote>
<br>
<br>
<p>参考了清华大学开源软件镜像站，pypi镜像使用帮助： <a href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</a></p>

                
            </div>
        </article>
    
</div>
<div class="paginator">
    
        
        
    
</div>

    </div>
</div>
<footer class="footer-social">
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2019
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/iJinxin">Victor</a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>
